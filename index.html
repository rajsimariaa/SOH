<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-6603110789295505">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6603110789295505"
     crossorigin="anonymous"></script>
    <title>Shades of Hue</title>
    
    <!-- 1. Load Styles (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                            950: '#0d1117',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- 2. Configure Modules (Import Map) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <!-- 3. Load Babel (To understand JSX code in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar for Chat */
        .overflow-y-auto::-webkit-scrollbar { width: 6px; }
        .overflow-y-auto::-webkit-scrollbar-track { background: transparent; }
        .overflow-y-auto::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .overflow-y-auto::-webkit-scrollbar-thumb { background-color: #4b5563; }
        
        body {
            transition: background-color 0.3s, color 0.3s;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans transition-colors duration-200">
    <div id="root"></div>

    <!-- 4. Your Application Code -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut,
            updatePassword,
            updateEmail,
            updateProfile,
            sendEmailVerification
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs, 
            getDoc,
            doc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            addDoc, 
            onSnapshot,
            serverTimestamp,
            orderBy,
            limit
        } from 'firebase/firestore';
        import { initializeApp } from 'firebase/app';
        import { 
            User, Shield, Building2, LogOut, Plus, Trash2, CheckCircle, XCircle, 
            Newspaper, MessageSquare, Menu, X, Heart, Briefcase, Send, 
            MessageCircle, IndianRupee, Check, Settings, Lock, Search, AlertCircle, Clock, Edit2, AlertTriangle, FileText,
            BookOpen, Users, Activity, Gift, Sun, Moon, Mail, ShoppingBag, Tag
        } from 'lucide-react';

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC907raHdPtNtNxBNLxImf7i-FfPIvglhE",
            authDomain: "sohh-7b016.firebaseapp.com",
            projectId: "sohh-7b016",
            storageBucket: "sohh-7b016.firebasestorage.app",
            messagingSenderId: "436729414470",
            appId: "1:436729414470:web:da0db38fedb21aaeac5b47",
            measurementId: "G-SDNWQPHX47"
        };

        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONSTANTS ---
        const SUPER_ADMINS = ['rajsimariaa@gmail.com', 'krutika3011@gmail.com'];
        const UPI_ID = "rajsimariaa-2@okaxis";

        // --- UI COMPONENTS ---
        const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500 shadow-md shadow-indigo-200 dark:shadow-none",
                secondary: "bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-gray-400",
                danger: "bg-rose-600 text-white hover:bg-rose-700 focus:ring-rose-500 shadow-md shadow-rose-200 dark:shadow-none",
                ghost: "text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white",
                success: "bg-emerald-600 text-white hover:bg-emerald-700 focus:ring-emerald-500"
            };
            return (
                <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Card = ({ children, className = '' }) => (
            <div className={`bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden transition-colors duration-200 ${className}`}>
                {children}
            </div>
        );

        const Badge = ({ children, color = 'blue' }) => {
            const colors = {
                blue: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300', 
                green: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300', 
                red: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300',
                purple: 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300', 
                gray: 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300', 
                indigo: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-300',
                orange: 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300',
                yellow: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300'
            };
            return <span className={`px-2.5 py-0.5 rounded-full text-xs font-semibold ${colors[color] || colors.gray}`}>{children}</span>;
        };

        // --- VERIFY EMAIL COMPONENT ---
        function VerifyEmailPage({ user, onSignOut }) {
            const [sent, setSent] = useState(false);
            const [error, setError] = useState('');
            const [checking, setChecking] = useState(false);

            const resendEmail = async () => {
                try {
                    await sendEmailVerification(user);
                    setSent(true);
                    setError('');
                } catch (e) {
                    setError('Too many requests. Please wait before retrying.');
                }
            };

            const checkVerification = async () => {
                setChecking(true);
                try {
                    await user.reload();
                    if (user.emailVerified) {
                        window.location.reload(); 
                    } else {
                        setError('Email not yet verified. Please check your inbox.');
                    }
                } catch(e) {
                    console.error(e);
                }
                setChecking(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 p-4">
                    <Card className="max-w-md w-full p-8 text-center">
                        <div className="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Mail size={32} />
                        </div>
                        <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-2">Verify your email</h2>
                        <p className="text-gray-600 dark:text-gray-300 mb-6">
                            We've sent a verification link to <strong>{user.email}</strong>.<br/>
                            Please verify your email to access the platform.
                        </p>
                        
                        {sent && <div className="mb-4 p-3 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg text-sm">Verification email sent!</div>}
                        {error && <div className="mb-4 p-3 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-lg text-sm">{error}</div>}

                        <div className="space-y-3">
                            <Button onClick={checkVerification} className="w-full justify-center" disabled={checking}>
                                {checking ? 'Checking...' : "I've Verified My Email"}
                            </Button>
                            <Button variant="secondary" onClick={resendEmail} className="w-full justify-center" disabled={sent}>
                                Resend Email
                            </Button>
                            <button onClick={onSignOut} className="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 underline mt-4">
                                Sign Out
                            </button>
                        </div>
                    </Card>
                </div>
            );
        }

        // --- TERMS MODAL ---
        function TermsModal({ onClose }) {
            return (
                <div className="fixed inset-0 bg-black/50 dark:bg-black/70 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-3xl w-full max-h-[85vh] flex flex-col border dark:border-gray-700">
                        <div className="p-5 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50 rounded-t-xl">
                            <h3 className="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                <FileText size={20} className="text-indigo-600 dark:text-indigo-400" /> Platform Policies & Guidelines
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 rounded p-1 transition-colors"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto text-sm text-gray-700 dark:text-gray-300 space-y-6 leading-relaxed">
                            <div>
                                <h4 className="font-bold text-lg text-gray-900 dark:text-white mb-2">Shades of Hue: Official Platform Policies and Guidelines</h4>
                                <p>These policies govern the conduct of all users, customers, and partnered organizations within the Shades of Hue platform.</p>
                            </div>
                            <div>
                                <h4 className="font-bold text-base text-gray-800 dark:text-gray-200 mb-2">I. Core Principles and Code of Conduct</h4>
                                <p>These principles are the foundation of our community and mandate the highest standards of professional and ethical behavior.</p>
                                <ul className="list-disc pl-5 mt-2 space-y-1">
                                    <li><strong>Mission Alignment:</strong> All panel organizations must actively align with the mission of supporting and empowering the queer community.</li>
                                    <li><strong>Respect and Professionalism:</strong> We enforce a Zero-Tolerance Policy for rude, aggressive, discriminatory, or harassing behavior.</li>
                                </ul>
                            </div>
                        </div>
                        <div className="p-5 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 rounded-b-xl flex justify-end">
                            <Button onClick={onClose}>Close</Button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- DONATION MODAL ---
        function DonationModal({ onClose }) {
            const [name, setName] = useState('');
            const [amount, setAmount] = useState('');
            const [step, setStep] = useState(1); 

            const handleNext = (e) => {
                e.preventDefault();
                if(name && amount) setStep(2);
            }

            const handleDone = async () => {
                try {
                    await addDoc(collection(db, 'donations'), {
                        name,
                        amount,
                        createdAt: serverTimestamp(),
                        status: 'user_confirmed'
                    });
                    alert("Thank you for your donation!");
                    onClose();
                } catch(e) {
                    console.error(e);
                    alert("Error recording donation.");
                }
            }

            return (
                <div className="fixed inset-0 bg-black/50 dark:bg-black/70 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-sm w-full border dark:border-gray-700">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                <Heart className="text-rose-600 fill-rose-600" size={24}/> Make a Donation
                            </h3>
                            <button onClick={onClose} className="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"><X size={20} /></button>
                        </div>
                        
                        {step === 1 ? (
                            <form onSubmit={handleNext} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Your Name</label>
                                    <input className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-rose-500 outline-none" value={name} onChange={e=>setName(e.target.value)} required placeholder="Enter your name" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Amount (₹)</label>
                                    <input type="number" className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-rose-500 outline-none" value={amount} onChange={e=>setAmount(e.target.value)} required placeholder="Enter amount" />
                                </div>
                                <Button type="submit" className="w-full bg-rose-600 hover:bg-rose-700 focus:ring-rose-500 shadow-rose-200 dark:shadow-none text-white">Proceed to Pay</Button>
                            </form>
                        ) : (
                            <div className="space-y-4">
                                <div className="bg-indigo-50 dark:bg-indigo-900/30 p-4 rounded-lg text-center border border-indigo-100 dark:border-indigo-800">
                                    <p className="text-sm text-gray-600 dark:text-gray-300 mb-2">Scan QR or use UPI ID</p>
                                    <div className="font-mono font-bold text-xl text-indigo-700 dark:text-indigo-400 select-all p-2 bg-white dark:bg-gray-800 rounded border border-indigo-200 dark:border-indigo-700">{UPI_ID}</div>
                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">Paying: <span className="font-bold text-gray-900 dark:text-white">₹{amount}</span></p>
                                </div>
                                <p className="text-xs text-center text-gray-500 dark:text-gray-400">Click below once you have completed the transaction in your UPI app.</p>
                                <Button onClick={handleDone} variant="success" className="w-full">Payment Done</Button>
                                <Button onClick={()=>setStep(1)} variant="ghost" className="w-full text-xs">Back</Button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- ORDER MODAL (NEW) ---
        function OrderModal({ product, onClose, onConfirm }) {
            const [address, setAddress] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onConfirm(address);
            };

            return (
                <div className="fixed inset-0 bg-black/50 dark:bg-black/70 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-sm w-full border dark:border-gray-700">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                <ShoppingBag size={24} className="text-indigo-600 dark:text-indigo-400" /> Order Details
                            </h3>
                            <button onClick={onClose}><X size={20} className="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200" /></button>
                        </div>
                        <div className="mb-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border dark:border-gray-600">
                            <p className="text-sm text-gray-600 dark:text-gray-300">
                                Item: <span className="font-bold text-gray-900 dark:text-white">{product.name}</span>
                            </p>
                            <p className="text-sm text-gray-600 dark:text-gray-300">
                                Price: <span className="font-bold text-indigo-600 dark:text-indigo-400">₹{product.price}</span>
                            </p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Delivery Address</label>
                                <textarea 
                                    className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500 resize-none" 
                                    rows={3}
                                    value={address} 
                                    onChange={e=>setAddress(e.target.value)} 
                                    required 
                                    placeholder="Enter your full address..." 
                                />
                            </div>
                            <Button type="submit" className="w-full">Confirm Order</Button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- NAVBAR COMPONENT ---
        function Navbar({ user, role, onNavigate, onSignOut, currentView, theme, toggleTheme }) {
            const [isOpen, setIsOpen] = useState(false);
            const NavLink = ({ target, label, icon: Icon }) => (
                <button onClick={() => { onNavigate(target); setIsOpen(false); }} className={`flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium transition-colors ${currentView === target ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white'}`}>
                    {Icon && <Icon size={16} />} {label}
                </button>
            );
            const roleLabel = role ? role.charAt(0).toUpperCase() + role.slice(1) : 'User';

            return (
                <nav className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 transition-colors duration-200">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex justify-between h-16">
                            <div className="flex items-center">
                                <button onClick={() => onNavigate('home')} className="flex-shrink-0 flex items-center gap-2 cursor-pointer">
                                    <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl">S</div>
                                    <span className="font-bold text-xl bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">Shades of Hue</span>
                                </button>
                            </div>
                            <div className="hidden md:flex items-center space-x-4">
                                <NavLink target="home" label="Home" icon={Newspaper} />
                                <NavLink target="store" label="Store" icon={ShoppingBag} />
                                {!user ? (
                                    <>
                                        <Button variant="ghost" onClick={() => onNavigate('login')}>Sign In</Button>
                                        <Button variant="primary" onClick={() => onNavigate('signup')}>Join Us</Button>
                                    </>
                                ) : (
                                    <>
                                        {role && <NavLink target="dashboard" label={`${roleLabel} Dashboard`} icon={Briefcase} />}
                                        <div className="border-l border-gray-300 dark:border-gray-600 h-6 mx-2"></div>
                                        <div className="flex items-center gap-3">
                                            <div className="text-right hidden lg:block">
                                                <p className="text-sm font-medium text-gray-900 dark:text-white">{user.email}</p>
                                                <p className="text-xs text-gray-500 dark:text-gray-400 capitalize">{role || '...'}</p>
                                            </div>
                                            <Button variant="secondary" onClick={onSignOut} className="!px-3"><LogOut size={16} /></Button>
                                        </div>
                                    </>
                                )}
                                <button onClick={toggleTheme} className="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                    {theme === 'dark' ? <Sun size={20} /> : <Moon size={20} />}
                                </button>
                            </div>
                            <div className="flex items-center md:hidden gap-2">
                                <button onClick={toggleTheme} className="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                                    {theme === 'dark' ? <Sun size={20} /> : <Moon size={20} />}
                                </button>
                                <button onClick={() => setIsOpen(!isOpen)} className="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white p-2">
                                    {isOpen ? <X size={24} /> : <Menu size={24} />}
                                </button>
                            </div>
                        </div>
                    </div>
                    {isOpen && (
                        <div className="md:hidden bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-2 pt-2 pb-3 space-y-1">
                            <NavLink target="home" label="Home" icon={Newspaper} />
                            <NavLink target="store" label="Store" icon={ShoppingBag} />
                            {user && role && <NavLink target="dashboard" label="Dashboard" icon={Briefcase} />}
                            {!user ? (
                                <div className="flex flex-col gap-2 p-2 mt-2 border-t border-gray-100 dark:border-gray-700">
                                    <Button variant="secondary" onClick={() => { onNavigate('login'); setIsOpen(false); }}>Sign In</Button>
                                    <Button variant="primary" onClick={() => { onNavigate('signup'); setIsOpen(false); }}>Join Us</Button>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-2 p-2 mt-2 border-t border-gray-100 dark:border-gray-700"><Button variant="danger" onClick={() => { onSignOut(); setIsOpen(false); }}>Sign Out</Button></div>
                            )}
                        </div>
                    )}
                </nav>
            );
        }

        // --- MAIN APP COMPONENT ---
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [userRole, setUserRole] = useState(null); 
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('home'); 
            const [verificationRequired, setVerificationRequired] = useState(false);
            
            // Theme Management
            const [theme, setTheme] = useState(() => {
                if (typeof window !== 'undefined') {
                    return localStorage.getItem('theme') || 'light';
                }
                return 'light';
            });

            useEffect(() => {
                const root = window.document.documentElement;
                if (theme === 'dark') {
                    root.classList.add('dark');
                } else {
                    root.classList.remove('dark');
                }
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prev => prev === 'light' ? 'dark' : 'light');
            };

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        setCurrentUser(user);
                        try {
                            if (SUPER_ADMINS.includes(user.email)) {
                                await setDoc(doc(db, 'users', user.uid), {
                                    email: user.email, role: 'admin', isActive: true, displayName: 'Super Admin', uid: user.uid
                                }, { merge: true });
                            }
                            const userDocSnap = await getDoc(doc(db, 'users', user.uid));
                            if (userDocSnap.exists()) {
                                const data = userDocSnap.data();
                                // Admin Deactivation Check
                                if (!data.isActive) {
                                    alert("Your account has been deactivated by an admin. Please contact support.");
                                    await signOut(auth);
                                    setCurrentUser(null);
                                    setUserRole(null);
                                    setView('home');
                                    setVerificationRequired(false);
                                } else {
                                    setUserData(data);
                                    setUserRole(data.role);
                                    // CHECK VERIFICATION FOR REGULAR USERS ONLY
                                    // Admins, Orgs, AND SELLERS are exempt from email verification check for login
                                    if (data.role === 'user' && !user.emailVerified) {
                                        setVerificationRequired(true);
                                    } else {
                                        setVerificationRequired(false);
                                    }
                                }
                            } else {
                                setUserRole('user'); 
                                // Default new user check
                                if (!user.emailVerified) setVerificationRequired(true);
                            }
                        } catch (error) {
                            console.error("Error fetching user data:", error);
                            setUserRole('user');
                        }
                    } else {
                        setCurrentUser(null);
                        setUserData(null);
                        setUserRole(null);
                        setView('home');
                        setVerificationRequired(false);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // --- PRESENCE SYSTEM (HEARTBEAT) ---
            useEffect(() => {
                if (!currentUser) return;
                
                const updatePresence = async () => {
                    try {
                        await updateDoc(doc(db, 'users', currentUser.uid), {
                            lastSeen: serverTimestamp()
                        });
                    } catch (err) {
                        console.error("Error updating presence:", err);
                    }
                };

                updatePresence();
                const intervalId = setInterval(updatePresence, 60 * 1000);
                return () => clearInterval(intervalId);
            }, [currentUser]);

            const handleSignOut = async () => { await signOut(auth); setView('home'); setUserRole(null); setVerificationRequired(false); };

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 dark:border-indigo-400"></div>
                </div>
            );

            // BLOCK ACCESS IF VERIFICATION IS REQUIRED
            if (verificationRequired) {
                return <VerifyEmailPage user={currentUser} onSignOut={handleSignOut} />;
            }

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans transition-colors duration-200">
                    <Navbar user={currentUser} role={userRole} onNavigate={setView} onSignOut={handleSignOut} currentView={view} theme={theme} toggleTheme={toggleTheme} />
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {view === 'home' && <Home user={currentUser} onNavigate={setView} />}
                        {view === 'store' && <Store user={currentUser} />}
                        {view === 'login' && <Login onNavigate={setView} />}
                        {view === 'signup' && <Signup onNavigate={setView} />}
                        {view === 'dashboard' && userRole === 'admin' && <AdminDashboard user={currentUser} />}
                        {view === 'dashboard' && userRole === 'organization' && <OrgDashboard user={currentUser} userData={userData} />}
                        {view === 'dashboard' && userRole === 'user' && <UserDashboard user={currentUser} userData={userData} />}
                        {view === 'dashboard' && userRole === 'seller' && <SellerDashboard user={currentUser} userData={userData} />}
                    </main>
                </div>
            );
        }

        // --- DASHBOARDS & PAGES ---
        function Home({ user, onNavigate }) {
            const [news, setNews] = useState([]);
            const [showDonate, setShowDonate] = useState(false);

            useEffect(() => {
                const unsubscribe = onSnapshot(query(collection(db, 'news'), orderBy('createdAt', 'desc')), 
                    (snapshot) => setNews(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))), 
                    (error) => console.error("News error:", error)
                );
                return () => unsubscribe();
            }, []);

            return (
                <div className="space-y-12 relative">
                    {showDonate && <DonationModal onClose={() => setShowDonate(false)} />}
                    <section className="text-center space-y-6 py-12">
                        <h1 className="text-4xl md:text-6xl font-extrabold text-gray-900 dark:text-white tracking-tight">Empowering the <span className="text-indigo-600 dark:text-indigo-400">Queer Community</span></h1>
                        <p className="max-w-2xl mx-auto text-lg md:text-xl text-gray-600 dark:text-gray-300">Connecting you with inclusive services, supportive organizations, and a community that cares.</p>
                        <div className="flex justify-center gap-4 flex-wrap">
                            {!user && (
                                <>
                                    <Button onClick={() => onNavigate('signup')} className="!text-lg !px-8 !py-3">Get Started</Button>
                                    <Button variant="secondary" onClick={() => onNavigate('login')} className="!text-lg !px-8 !py-3">Sign In</Button>
                                </>
                            )}
                            <button 
                                onClick={() => setShowDonate(true)}
                                className="flex items-center gap-2 px-8 py-3 rounded-lg font-medium text-lg bg-rose-600 text-white hover:bg-rose-700 shadow-md shadow-rose-200 dark:shadow-none transition-all"
                            >
                                <Heart className="fill-white" size={20} /> Donate
                            </button>
                        </div>
                    </section>
                    
                    <div className="grid md:grid-cols-2 gap-8">
                        <Card className="p-8 bg-gradient-to-br from-indigo-50 to-white dark:from-gray-800 dark:to-gray-750 border-indigo-100 dark:border-gray-700">
                            <div className="flex items-center gap-3 mb-4"><div className="p-2 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg text-indigo-600 dark:text-indigo-300"><Heart size={24} /></div><h2 className="text-2xl font-bold text-gray-900 dark:text-white">Our Mission</h2></div>
                            <p className="text-gray-600 dark:text-gray-300 leading-relaxed">To provide a safe, accessible, and affirmative platform for Queer individuals to access essential services.</p>
                        </Card>
                        <Card className="p-8 bg-gradient-to-br from-purple-50 to-white dark:from-gray-800 dark:to-gray-750 border-purple-100 dark:border-gray-700">
                            <div className="flex items-center gap-3 mb-4"><div className="p-2 bg-purple-100 dark:bg-purple-900/50 rounded-lg text-purple-600 dark:text-purple-300"><Shield size={24} /></div><h2 className="text-2xl font-bold text-gray-900 dark:text-white">Our Vision</h2></div>
                            <p className="text-gray-600 dark:text-gray-300 leading-relaxed">A world where every Queer individual has equal access to healthcare, legal aid, housing, and community support.</p>
                        </Card>
                    </div>

                    <section className="py-8">
                        <div className="text-center mb-8">
                          <h2 className="text-3xl font-bold text-gray-900 dark:text-white">Our Services</h2>
                          <p className="text-gray-600 dark:text-gray-400 mt-2">Holistic support for the community.</p>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                          {[
                            { icon: BookOpen, title: "Skill Development", desc: "Training programs to enhance your professional skillset." },
                            { icon: Briefcase, title: "Employment", desc: "Connecting you with inclusive employers and job opportunities." },
                            { icon: Users, title: "Inclusivity Workshops", desc: "Sensitization and awareness sessions for organizations." },
                            { icon: Heart, title: "Mental Health", desc: "Counseling and support groups for emotional well-being." }
                          ].map((s, i) => (
                            <Card key={i} className="p-6 text-center hover:shadow-md dark:hover:bg-gray-750 transition-all">
                              <div className="w-12 h-12 mx-auto bg-indigo-50 dark:bg-indigo-900/30 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-400 mb-4">
                                <s.icon size={24} />
                              </div>
                              <h3 className="font-bold text-lg text-gray-900 dark:text-white mb-2">{s.title}</h3>
                              <p className="text-sm text-gray-600 dark:text-gray-400">{s.desc}</p>
                            </Card>
                          ))}
                        </div>
                    </section>

                    <section>
                        <div className="flex items-center gap-3 mb-6"><Newspaper className="text-indigo-600 dark:text-indigo-400" /><h2 className="text-2xl font-bold text-gray-900 dark:text-white">Latest Updates</h2></div>
                        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                            {news.length > 0 ? news.map(item => (
                                <Card key={item.id} className="p-6 flex flex-col h-full hover:shadow-md transition-shadow">
                                    <div className="mb-4"><span className="text-xs font-medium text-gray-500 dark:text-gray-400">{item.createdAt?.toDate ? item.createdAt.toDate().toLocaleDateString() : 'Just now'}</span><h3 className="text-xl font-bold text-gray-900 dark:text-white mt-1">{item.title}</h3></div>
                                    <p className="text-gray-600 dark:text-gray-300 text-sm flex-grow whitespace-pre-wrap">{item.content}</p>
                                </Card>
                            )) : <div className="col-span-full text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-xl border border-dashed border-gray-300 dark:border-gray-700 text-gray-500 dark:text-gray-400">No news updates yet. Stay tuned!</div>}
                        </div>
                    </section>
                </div>
            );
        }

        function Store({ user }) {
            const [products, setProducts] = useState([]);
            const [selectedProduct, setSelectedProduct] = useState(null);
            
            useEffect(() => {
                const q = query(collection(db, 'products'), orderBy('createdAt', 'desc'));
                const unsub = onSnapshot(q, (s) => setProducts(s.docs.map(d => ({id:d.id, ...d.data()}))), (e) => console.log("Store load err", e));
                return () => unsub();
            }, []);

            const handleBuyClick = (product) => {
                if(!user) { alert("Please login to buy products."); return; }
                setSelectedProduct(product);
            };

            const confirmOrder = async (address) => {
                if (!selectedProduct) return;
                
                try {
                    await addDoc(collection(db, 'orders'), {
                        productId: selectedProduct.id,
                        productName: selectedProduct.name,
                        price: selectedProduct.price,
                        sellerId: selectedProduct.sellerId,
                        buyerId: user.uid,
                        buyerEmail: user.email,
                        address: address, // Added address
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    alert("Order placed successfully!");
                    setSelectedProduct(null);
                } catch(e) {
                    console.error(e);
                    alert("Failed to place order.");
                }
            };

            return (
                <div className="space-y-8 relative">
                    {selectedProduct && <OrderModal product={selectedProduct} onClose={() => setSelectedProduct(null)} onConfirm={confirmOrder} />}
                    
                    <div className="text-center space-y-2">
                        <h2 className="text-3xl font-bold text-gray-900 dark:text-white">Community Store</h2>
                        <p className="text-gray-600 dark:text-gray-400">Support local creators and small businesses.</p>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        {products.map(p => (
                            <Card key={p.id} className="flex flex-col h-full hover:shadow-lg transition-shadow">
                                <div className="aspect-square bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400">
                                    {/* Placeholder for Product Image */}
                                    <ShoppingBag size={48} opacity={0.2} />
                                </div>
                                <div className="p-4 flex flex-col flex-grow">
                                    <h3 className="font-bold text-lg text-gray-900 dark:text-white mb-1">{p.name}</h3>
                                    <p className="text-sm text-gray-500 dark:text-gray-400 mb-3 flex-grow">{p.description}</p>
                                    <div className="flex justify-between items-center mt-auto">
                                        <span className="font-bold text-indigo-600 dark:text-indigo-400">₹{p.price}</span>
                                        <Button onClick={() => handleBuyClick(p)} className="!py-1 !px-3 !text-sm">Buy Now</Button>
                                    </div>
                                </div>
                            </Card>
                        ))}
                    </div>
                    {products.length === 0 && <p className="text-center text-gray-500 dark:text-gray-400 py-12">No products available yet.</p>}
                </div>
            );
        }

        function SellerDashboard({ user }) {
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [newProd, setNewProd] = useState({ name: '', price: '', description: '' });
            const [deletingId, setDeletingId] = useState(null); // Add state for deletion confirmation

            useEffect(() => {
                const qP = query(collection(db, 'products'), where('sellerId', '==', user.uid));
                const unsubP = onSnapshot(qP, s => setProducts(s.docs.map(d => ({id:d.id, ...d.data()}))), (e) => console.log("Seller P err", e));
                
                const qO = query(collection(db, 'orders'), where('sellerId', '==', user.uid));
                const unsubO = onSnapshot(qO, s => setOrders(s.docs.map(d => ({id:d.id, ...d.data()}))), (e) => console.log("Seller O err", e));

                return () => { unsubP(); unsubO(); };
            }, [user.uid]);

            const addProduct = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'products'), {
                    ...newProd,
                    price: Number(newProd.price),
                    sellerId: user.uid,
                    sellerName: user.displayName || user.email,
                    createdAt: serverTimestamp()
                });
                setNewProd({ name: '', price: '', description: '' });
            };

            const handleDeleteClick = (id) => {
                setDeletingId(id);
            }

            const confirmDelete = async (id) => {
                try {
                    await deleteDoc(doc(db, 'products', id));
                    setDeletingId(null);
                } catch (e) {
                    console.error("Delete failed: ", e);
                    alert("Failed to delete product: " + e.message); 
                }
            };

            const cancelDelete = () => {
                setDeletingId(null);
            }

            const updateOrder = async (id, status) => {
                await updateDoc(doc(db, 'orders', id), { status });
            };

            return (
                <div className="grid lg:grid-cols-3 gap-8">
                    <div className="lg:col-span-1 space-y-6">
                        <Card className="p-6">
                            <h3 className="font-bold text-gray-900 dark:text-white mb-4">Add Product</h3>
                            <form onSubmit={addProduct} className="space-y-4">
                                <input className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Product Name" value={newProd.name} onChange={e=>setNewProd({...newProd, name:e.target.value})} required />
                                <input type="number" className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Price (₹)" value={newProd.price} onChange={e=>setNewProd({...newProd, price:e.target.value})} required />
                                <textarea className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows={3} placeholder="Description" value={newProd.description} onChange={e=>setNewProd({...newProd, description:e.target.value})} required />
                                <Button type="submit" className="w-full">List Item</Button>
                            </form>
                        </Card>
                    </div>

                    <div className="lg:col-span-2 space-y-8">
                        <Card className="p-6">
                            <h3 className="font-bold text-gray-900 dark:text-white mb-4">My Products</h3>
                            <div className="space-y-3">
                                {products.map(p => (
                                    <div key={p.id} className="flex justify-between items-center p-3 border rounded dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                                        <div>
                                            <div className="font-bold text-gray-900 dark:text-white">{p.name}</div>
                                            <div className="text-sm text-gray-500 dark:text-gray-400">₹{p.price}</div>
                                        </div>
                                        {deletingId === p.id ? (
                                            <div className="flex gap-2">
                                                <button onClick={() => confirmDelete(p.id)} className="text-red-600 font-bold text-xs hover:underline">Confirm</button>
                                                <button onClick={cancelDelete} className="text-gray-500 text-xs hover:underline">Cancel</button>
                                            </div>
                                        ) : (
                                            <button onClick={()=>handleDeleteClick(p.id)} className="text-red-500 hover:text-red-700" title="Delete Product"><Trash2 size={18}/></button>
                                        )}
                                    </div>
                                ))}
                                {products.length === 0 && <p className="text-gray-500">No products listed.</p>}
                            </div>
                        </Card>

                        <Card className="p-6">
                            <h3 className="font-bold text-gray-900 dark:text-white mb-4">Incoming Orders</h3>
                            <div className="space-y-3">
                                {orders.map(o => (
                                    <div key={o.id} className="p-4 border rounded dark:border-gray-700 bg-white dark:bg-gray-800">
                                        <div className="flex justify-between mb-2">
                                            <span className="font-bold text-indigo-600 dark:text-indigo-400">{o.productName}</span>
                                            <Badge color={o.status === 'completed' ? 'green' : 'yellow'}>{o.status}</Badge>
                                        </div>
                                        <div className="text-sm text-gray-600 dark:text-gray-300 mb-3">
                                            <div><span className="font-semibold">Buyer:</span> {o.buyerEmail}</div>
                                            <div><span className="font-semibold">Amount:</span> ₹{o.price}</div>
                                            {o.address && (
                                                <div className="mt-1 p-2 bg-gray-50 dark:bg-gray-700 rounded border dark:border-gray-600">
                                                    <span className="font-semibold block text-xs uppercase text-gray-500 dark:text-gray-400">Shipping Address:</span>
                                                    {o.address}
                                                </div>
                                            )}
                                        </div>
                                        {o.status === 'pending' && (
                                            <div className="flex gap-2">
                                                <Button onClick={()=>updateOrder(o.id, 'completed')} variant="success" className="!py-1 !text-xs">Mark Completed</Button>
                                                <Button onClick={()=>updateOrder(o.id, 'cancelled')} variant="danger" className="!py-1 !text-xs">Cancel</Button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                                {orders.length === 0 && <p className="text-gray-500">No orders yet.</p>}
                            </div>
                        </Card>
                    </div>
                </div>
            );
        }

        function Login({ onNavigate }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const handleLogin = async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, email, password); onNavigate('home'); } catch (err) { setError("Failed to login. Please check your credentials."); } };
            return (
                <div className="max-w-md mx-auto mt-12">
                    <Card className="p-8">
                        <div className="text-center mb-8"><h2 className="text-2xl font-bold text-gray-900 dark:text-white">Welcome Back</h2><p className="text-gray-500 dark:text-gray-400 mt-2">Sign in to your account</p></div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            {error && <div className="p-3 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 text-sm rounded-lg">{error}</div>}
                            <input type="email" placeholder="Email Address" required className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" value={email} onChange={(e) => setEmail(e.target.value)} />
                            <input type="password" placeholder="Password" required className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" value={password} onChange={(e) => setPassword(e.target.value)} />
                            <Button type="submit" className="w-full">Sign In</Button>
                        </form>
                        <p className="text-center mt-6 text-sm text-gray-600 dark:text-gray-400">Don't have an account? <button onClick={() => onNavigate('signup')} className="text-indigo-600 dark:text-indigo-400 font-medium hover:underline">Sign up</button></p>
                    </Card>
                </div>
            );
        }

        function Signup({ onNavigate }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [agreed, setAgreed] = useState(false);
            const [showTerms, setShowTerms] = useState(false);
            
            const handleSignup = async (e) => { 
                e.preventDefault(); 
                if (!agreed) {
                    setError("You must agree to the Terms and Conditions to create an account.");
                    return;
                }
                try { 
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password); 
                    await sendEmailVerification(userCredential.user);
                    await setDoc(doc(db, 'users', userCredential.user.uid), { 
                        uid: userCredential.user.uid, 
                        email, 
                        displayName: name, 
                        role: 'user', 
                        isActive: true, 
                        termsAccepted: true,
                        termsAcceptedAt: serverTimestamp(),
                        createdAt: serverTimestamp(),
                        lastSeen: serverTimestamp()
                    }); 
                } catch (err) { 
                    setError(err.message); 
                } 
            };

            return (
                <div className="max-w-md mx-auto mt-12">
                    <Card className="p-8">
                        <div className="text-center mb-8"><h2 className="text-2xl font-bold text-gray-900 dark:text-white">Join Shades of Hue</h2><p className="text-gray-500 dark:text-gray-400 mt-2">Create your account today</p></div>
                        <form onSubmit={handleSignup} className="space-y-6">
                            {error && <div className="p-3 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 text-sm rounded-lg">{error}</div>}
                            <input type="text" placeholder="Full Name" required className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" value={name} onChange={(e) => setName(e.target.value)} />
                            <input type="email" placeholder="Email Address" required className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" value={email} onChange={(e) => setEmail(e.target.value)} />
                            <input type="password" placeholder="Password (min 6 chars)" required minLength={6} className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" value={password} onChange={(e) => setPassword(e.target.value)} />
                            
                            <div className="flex items-start gap-2 text-sm text-gray-600 dark:text-gray-400 px-1">
                                <input 
                                    type="checkbox" 
                                    id="terms" 
                                    checked={agreed} 
                                    onChange={(e) => setAgreed(e.target.checked)}
                                    className="mt-1"
                                />
                                <label htmlFor="terms">
                                    I agree to the <button type="button" onClick={() => setShowTerms(true)} className="text-indigo-600 dark:text-indigo-400 hover:underline font-medium">Terms and Conditions</button>
                                </label>
                            </div>

                            <Button type="submit" className="w-full">Sign Up</Button>
                        </form>
                        <p className="text-center mt-6 text-sm text-gray-600 dark:text-gray-400">Already have an account? <button onClick={() => onNavigate('login')} className="text-indigo-600 dark:text-indigo-400 font-medium hover:underline">Sign in</button></p>
                    </Card>
                    {showTerms && <TermsModal onClose={() => setShowTerms(false)} />}
                </div>
            );
        }

        // --- RENDER APP ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>