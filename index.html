<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-5610359497866484">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5610359497866484"
     crossorigin="anonymous"></script>
    <title>Shades of Hue</title>
    
    <!-- 1. Load Styles (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Configure Modules (Import Map) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <!-- 3. Load Babel (To understand JSX code in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar for Chat */
        .overflow-y-auto::-webkit-scrollbar { width: 6px; }
        .overflow-y-auto::-webkit-scrollbar-track { background: transparent; }
        .overflow-y-auto::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="root"></div>

    <!-- 4. Your Application Code -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut,
            updatePassword,
            updateEmail,
            updateProfile,
            sendEmailVerification
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs, 
            getDoc, 
            doc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            addDoc, 
            onSnapshot,
            serverTimestamp,
            orderBy,
            limit
        } from 'firebase/firestore';
        import { initializeApp } from 'firebase/app';
        import { 
            User, Shield, Building2, LogOut, Plus, Trash2, CheckCircle, XCircle, 
            Newspaper, MessageSquare, Menu, X, Heart, Briefcase, Send, 
            MessageCircle, IndianRupee, Check, Settings, Lock, Search, AlertCircle, Clock, Edit2, AlertTriangle, FileText,
            BookOpen, Users, Mail, Star, ThumbsUp, Activity, ShoppingBag
        } from 'lucide-react';

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC907raHdPtNtNxBNLxImf7i-FfPIvglhE",
            authDomain: "sohh-7b016.firebaseapp.com",
            projectId: "sohh-7b016",
            storageBucket: "sohh-7b016.firebasestorage.app",
            messagingSenderId: "436729414470",
            appId: "1:436729414470:web:da0db38fedb21aaeac5b47",
            measurementId: "G-SDNWQPHX47"
        };

        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONSTANTS ---
        const SUPER_ADMINS = ['rajsimariaa@gmail.com', 'krutika3011@gmail.com'];
        const UPI_ID = "rajsimariaa-2@okaxis";

        // --- UI COMPONENTS ---
        const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500 shadow-md shadow-indigo-200",
                secondary: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 focus:ring-gray-400",
                danger: "bg-rose-600 text-white hover:bg-rose-700 focus:ring-rose-500 shadow-md shadow-rose-200",
                ghost: "text-gray-600 hover:bg-gray-100 hover:text-gray-900",
                success: "bg-emerald-600 text-white hover:bg-emerald-700 focus:ring-emerald-500"
            };
            return (
                <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Card = ({ children, className = '' }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        const Badge = ({ children, color = 'blue' }) => {
            const colors = {
                blue: 'bg-blue-100 text-blue-800', 
                green: 'bg-green-100 text-green-800', 
                red: 'bg-red-100 text-red-800',
                purple: 'bg-purple-100 text-purple-800', 
                gray: 'bg-gray-100 text-gray-800', 
                indigo: 'bg-indigo-100 text-indigo-800',
                orange: 'bg-orange-100 text-orange-800',
                yellow: 'bg-yellow-100 text-yellow-800'
            };
            return <span className={`px-2.5 py-0.5 rounded-full text-xs font-semibold ${colors[color] || colors.gray}`}>{children}</span>;
        };

        const StarRating = ({ rating }) => (
            <div className="flex text-yellow-400">
                {[...Array(5)].map((_, i) => (
                    <Star key={i} size={14} fill={i < rating ? "currentColor" : "none"} className={i < rating ? "text-yellow-400" : "text-gray-300"} />
                ))}
            </div>
        );

        // --- TERMS MODAL ---
        function TermsModal({ onClose }) {
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[85vh] flex flex-col">
                        <div className="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <h3 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                                <FileText size={20} className="text-indigo-600" /> Platform Policies & Guidelines
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded p-1 transition-colors"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto text-sm text-gray-700 space-y-6 leading-relaxed">
                            {/* Contact Information Section Added */}
                            <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                                <h4 className="font-bold text-base text-indigo-900 mb-2">Contact Information</h4>
                                <div className="space-y-1 text-indigo-800">
                                    <p><span className="font-semibold">Email:</span> shadesofhue2025@gmail.com</p>
                                    <p><span className="font-semibold">Phone:</span> +91 9833201718 / +91 80970 86929</p>
                                </div>
                            </div>

                            <div>
                                <h4 className="font-bold text-lg text-gray-900 mb-2">Shades of Hue: Official Platform Policies and Guidelines</h4>
                                <p>These policies govern the conduct of all users, customers, and partnered organizations within the Shades of Hue platform.</p>
                            </div>
                            
                            <div>
                                <h4 className="font-bold text-base text-gray-800 mb-2">I. Core Principles and Code of Conduct</h4>
                                <ul className="list-disc pl-5 mt-2 space-y-1">
                                    <li><strong>Mission Alignment:</strong> All panel organizations must actively align with the mission of supporting and empowering the queer community. Adherence to a strict Non-Discrimination Policy based on sexual orientation, gender identity, religion, background, or ability is mandatory.</li>
                                    <li><strong>Respect and Professionalism:</strong> We enforce a Zero-Tolerance Policy for rude, aggressive, discriminatory, or harassing behavior. Professionalism is expected at all times toward customers, platform users, and Shades of Hue administrators.</li>
                                    <li><strong>Prioritization of Stakeholders:</strong> The platform is dedicated to ensuring the highest quality service and privacy for our customers while providing clear operational guidelines and fair support for our Partner Organizations.</li>
                                </ul>
                            </div>

                            <div>
                                <h4 className="font-bold text-base text-gray-800 mb-2">II. Customer Privacy and Data Protection Policy</h4>
                                <ul className="list-disc pl-5 mt-2 space-y-1">
                                    <li><strong>Anonymity & Confidentiality:</strong> User data is encrypted and handled in strict confidence. Customers have the right to maintain a degree of anonymity until they choose to share further details directly with a partner organization.</li>
                                    <li><strong>Limited Information Disclosure to Partners:</strong> Upon a confirmed match, partner organizations will only be provided with the minimal, non-sensitive identifying details required.</li>
                                    <li><strong>Monitoring for Safety:</strong> For the protection of all parties and to maintain platform integrity, all primary chat initiations within the Shades of Hue application are monitored by trained administrators. This monitoring is solely for dispute resolution and policy enforcement (e.g., preventing poaching).</li>
                                </ul>
                            </div>

                            <div>
                                <h4 className="font-bold text-base text-gray-800 mb-2">III. Service Request Management and Service Level Agreement (SLA)</h4>
                                <ul className="list-disc pl-5 mt-2 space-y-1">
                                    <li><strong>Request Acceptance Window:</strong> Partner organizations must review all submitted customer requests and issue a definitive Accept or Decline decision within a maximum period of 10 business days (1 to 2 weeks) from the time the request is assigned.</li>
                                    <li><strong>Mandatory Decline Rationale:</strong> If a request is declined, the organization is required to provide a clear and concise reason to Shades of Hue administration (e.g., capacity issues, specialization mismatch, conflict of interest).</li>
                                    <li><strong>Optimal Matching Commitment:</strong> Shades of Hue commits to matching customers with the most suitable partner based on the customer's needs and the organization's expertise, ensuring a targeted and high-quality connection.</li>
                                </ul>
                            </div>

                            <div>
                                <h4 className="font-bold text-base text-gray-800 mb-2">IV. Accountability and Quality Assurance</h4>
                                <ul className="list-disc pl-5 mt-2 space-y-1">
                                    <li><strong>Grounds for a Strike:</strong> A strike may be issued to a partner organization for instances of failure to satisfy a customer's essential needs or if a customer issue significantly escalates due to negligence, prolonged unresponsiveness, or poor conduct.</li>
                                    <li><strong>Dispute Resolution Meeting:</strong> Strikes are not applied automatically. Before any strike is issued, a mandatory Dispute Resolution Meeting will be held. This meeting will include the customer, the organization's representative, and a Shades of Hue administrator, who will objectively review all facts and testimony to render a final decision.</li>
                                    <li><strong>Suspension Protocol:</strong> An organization with a strike will not be able to receive new customer leads and will be suspended for thirty (30) days/one (1) calendar month.</li>
                                    <li><strong>Account Deletion Protocol:</strong> An organization with 3 or more strikes will have their account deleted permanently.</li>
                                    <li><strong>Continuity of Service:</strong> Crucially, the suspension only restricts new leads. The organization must continue and complete all ongoing services, projects, or existing client relationships during the suspension period without interruption.</li>
                                </ul>
                            </div>

                            <div>
                                <h4 className="font-bold text-base text-gray-800 mb-2">V. Ethical Conduct, Partner Protection, and Termination</h4>
                                <ul className="list-disc pl-5 mt-2 space-y-1">
                                    <li><strong>Zero-Tolerance for Customer Poaching:</strong> Any attempt by a partner organization to solicit, recruit, or poach a customer outside of the Shades of Hue platform where the initial engagement was facilitated and monitored via our app's chat will result in the immediate and permanent termination of the organization's account and its listing.</li>
                                    <li><strong>Mandatory Reporting of Issues:</strong> Partner organizations are required to report any disruptive, abusive, or problematic behavior from a customer to the Shades of Hue administration at the earliest opportunity for intervention and support.</li>
                                    <li><strong>Voluntary Termination Notice:</strong> If a partner organization decides to terminate its relationship with Shades of Hue, they are required to serve a mandatory 30-day termination period. During this period, they must complete all existing commitments and may not accept any new leads.</li>
                                </ul>
                            </div>

                            <div>
                                <h4 className="font-bold text-base text-gray-800 mb-2">VI. Platform Communication and Policy Changes</h4>
                                <ul className="list-disc pl-5 mt-2 space-y-1">
                                    <li><strong>Advance Notice for Major Changes:</strong> Shades of Hue is committed to transparent governance. We will provide all partner organizations with a minimum of 15 days' advance written notice before implementing any major changes to platform policies, guidelines, or core operational procedures. This ensures partners have adequate time to adapt and prepare.</li>
                                </ul>
                            </div>
                        </div>
                        <div className="p-5 border-t border-gray-100 bg-gray-50 rounded-b-xl flex justify-end">
                            <Button onClick={onClose}>Close</Button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- FEEDBACK MODAL ---
        function FeedbackModal({ onClose, onSubmit }) {
            const [rating, setRating] = useState(0);
            const [comment, setComment] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (rating === 0) {
                    alert("Please select a rating!");
                    return;
                }
                onSubmit({ rating, comment });
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                        <div className="text-center mb-6">
                            <div className="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 mx-auto mb-3">
                                <Star size={24} fill="currentColor" />
                            </div>
                            <h3 className="text-xl font-bold text-gray-900">Rate Your Experience</h3>
                            <p className="text-gray-500 text-sm mt-1">How was the service provided?</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div className="flex justify-center gap-2">
                                {[1, 2, 3, 4, 5].map((star) => (
                                    <button
                                        key={star}
                                        type="button"
                                        onClick={() => setRating(star)}
                                        className="focus:outline-none transition-transform hover:scale-110"
                                    >
                                        <Star 
                                            size={32} 
                                            fill={star <= rating ? "#FACC15" : "none"} 
                                            className={star <= rating ? "text-yellow-400" : "text-gray-300"} 
                                        />
                                    </button>
                                ))}
                            </div>
                            
                            <textarea
                                className="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none"
                                rows={4}
                                placeholder="Share your feedback (optional)..."
                                value={comment}
                                onChange={(e) => setComment(e.target.value)}
                            />

                            <div className="flex gap-3">
                                <Button variant="secondary" onClick={onClose} className="flex-1">Cancel</Button>
                                <Button type="submit" className="flex-1">Submit Feedback</Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // --- DECLINE REASON MODAL ---
        function DeclineModal({ onClose, onSubmit }) {
            const [reason, setReason] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!reason.trim()) {
                    alert("Please provide a reason for declining.");
                    return;
                }
                onSubmit(reason);
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-gray-900 text-red-600 flex items-center gap-2">
                                <XCircle size={24} /> Decline Request
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={24} /></button>
                        </div>
                        
                        <p className="text-sm text-gray-600 mb-4">
                            Per platform policy, you must provide a reason for declining this request. This will be recorded.
                        </p>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <textarea
                                className="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-red-500 outline-none resize-none"
                                rows={4}
                                placeholder="E.g., Capacity issues, specialization mismatch, conflict of interest..."
                                value={reason}
                                onChange={(e) => setReason(e.target.value)}
                                required
                            />

                            <div className="flex gap-3">
                                <Button variant="secondary" onClick={onClose} className="flex-1">Cancel</Button>
                                <Button type="submit" variant="danger" className="flex-1">Confirm Decline</Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // --- FOOTER COMPONENT ---
        function Footer({ onShowTerms }) {
            return (
                <footer className="bg-white border-t border-gray-200 mt-12 py-8">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-2">
                            <div className="w-6 h-6 rounded bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-xs">S</div>
                            <span className="font-bold text-gray-900">Shades of Hue</span>
                        </div>
                        <div className="flex flex-wrap justify-center gap-6 text-sm text-gray-500">
                            <span>&copy; {new Date().getFullYear()} Shades of Hue. All rights reserved.</span>
                            <button 
                                onClick={onShowTerms} 
                                className="hover:text-indigo-600 transition-colors underline"
                            >
                                Terms & Conditions
                            </button>
                        </div>
                    </div>
                </footer>
            );
        }

        // --- SHARED COMPONENTS ---
        function Navbar({ user, role, onNavigate, onSignOut, currentView }) {
            const [isOpen, setIsOpen] = useState(false);
            const NavLink = ({ target, label, icon: Icon }) => (
                <button onClick={() => { onNavigate(target); setIsOpen(false); }} className={`flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium transition-colors ${currentView === target ? 'bg-indigo-50 text-indigo-700' : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'}`}>
                    {Icon && <Icon size={16} />} {label}
                </button>
            );
            const roleLabel = role ? role.charAt(0).toUpperCase() + role.slice(1) : 'User';

            return (
                <nav className="bg-white border-b border-gray-200 sticky top-0 z-50">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex justify-between h-16">
                            <div className="flex items-center">
                                <button onClick={() => onNavigate('home')} className="flex-shrink-0 flex items-center gap-2 cursor-pointer">
                                    <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl">S</div>
                                    <span className="font-bold text-xl bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">Shades of Hue</span>
                                </button>
                            </div>
                            <div className="hidden md:flex items-center space-x-4">
                                <NavLink target="home" label="Home" icon={Newspaper} />
                                {/* Added Shop Link */}
                                <a href="shop.html" className="flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100 hover:text-gray-900 transition-colors">
                                    <ShoppingBag size={16} /> Shop
                                </a>
                                {!user ? (
                                    <>
                                        <Button variant="ghost" onClick={() => onNavigate('login')}>Sign In</Button>
                                        <Button variant="primary" onClick={() => onNavigate('signup')}>Join Us</Button>
                                    </>
                                ) : (
                                    <>
                                        {role && <NavLink target="dashboard" label={`${roleLabel} Dashboard`} icon={Briefcase} />}
                                        <div className="border-l border-gray-300 h-6 mx-2"></div>
                                        <div className="flex items-center gap-3">
                                            <div className="text-right hidden lg:block">
                                                <p className="text-sm font-medium text-gray-900">{user.email}</p>
                                                <p className="text-xs text-gray-500 capitalize">{role || '...'}</p>
                                            </div>
                                            <Button variant="secondary" onClick={onSignOut} className="!px-3"><LogOut size={16} /></Button>
                                        </div>
                                    </>
                                )}
                            </div>
                            <div className="flex items-center md:hidden">
                                <button onClick={() => setIsOpen(!isOpen)} className="text-gray-600 hover:text-gray-900 p-2">{isOpen ? <X size={24} /> : <Menu size={24} />}</button>
                            </div>
                        </div>
                    </div>
                    {isOpen && (
                        <div className="md:hidden bg-white border-b border-gray-200 px-2 pt-2 pb-3 space-y-1">
                            <NavLink target="home" label="Home" icon={Newspaper} />
                            {/* Added Shop Link for Mobile */}
                            <a href="shop.html" className="flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100 hover:text-gray-900 transition-colors">
                                <ShoppingBag size={16} /> Shop
                            </a>
                            {user && role && <NavLink target="dashboard" label="Dashboard" icon={Briefcase} />}
                            {!user ? (
                                <div className="flex flex-col gap-2 p-2 mt-2 border-t border-gray-100">
                                    <Button variant="secondary" onClick={() => { onNavigate('login'); setIsOpen(false); }}>Sign In</Button>
                                    <Button variant="primary" onClick={() => { onNavigate('signup'); setIsOpen(false); }}>Join Us</Button>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-2 p-2 mt-2 border-t border-gray-100"><Button variant="danger" onClick={() => { onSignOut(); setIsOpen(false); }}>Sign Out</Button></div>
                            )}
                        </div>
                    )}
                </nav>
            );
        }

        function ChatWindow({ chatId, onClose, currentUser }) {
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [chatInfo, setChatInfo] = useState(null);
            const bottomRef = useRef(null);

            useEffect(() => {
                const fetchChatInfo = async () => {
                    try {
                        const docSnap = await getDoc(doc(db, 'chats', chatId));
                        if (docSnap.exists()) setChatInfo(docSnap.data());
                    } catch (e) { console.error("Chat info error:", e); }
                };
                fetchChatInfo();
                const q = query(collection(db, 'chats', chatId, 'messages'), orderBy('timestamp', 'asc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setTimeout(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                }, (error) => console.error("Chat messages error:", error));
                return () => unsubscribe();
            }, [chatId]);

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!newMessage.trim()) return;
                try {
                    await addDoc(collection(db, 'chats', chatId, 'messages'), {
                        text: newMessage, senderId: currentUser.uid, senderEmail: currentUser.email, timestamp: serverTimestamp()
                    });
                    await updateDoc(doc(db, 'chats', chatId), { lastMessage: newMessage, lastMessageTime: serverTimestamp() });
                    setNewMessage('');
                } catch (error) { console.error("Error sending message:", error); }
            };

            const getOtherParticipantName = () => {
                if (!chatInfo || !chatInfo.participantData) return "Chat";
                const otherUid = chatInfo.participants.find(uid => uid !== currentUser.uid);
                const participant = chatInfo.participantData[otherUid];
                return participant?.name || "User";
            };

            return (
                <div className="fixed bottom-4 right-4 w-96 h-[500px] bg-white rounded-xl shadow-2xl border border-gray-200 flex flex-col z-50 overflow-hidden">
                    <div className="bg-indigo-600 text-white p-4 flex justify-between items-center shrink-0">
                        <div className="flex items-center gap-2"><MessageCircle size={20} /><span className="font-bold truncate">{getOtherParticipantName()}</span></div>
                        <button onClick={onClose} className="hover:bg-indigo-700 p-1 rounded"><X size={18} /></button>
                    </div>
                    <div className="flex-grow p-4 overflow-y-auto bg-gray-50 flex flex-col gap-3">
                        {messages.map((msg) => {
                            const isMe = msg.senderId === currentUser.uid;
                            return (
                                <div key={msg.id} className={`max-w-[80%] p-3 rounded-lg text-sm ${isMe ? 'bg-indigo-100 text-indigo-900 self-end rounded-br-none' : 'bg-white border border-gray-200 text-gray-800 self-start rounded-bl-none'}`}>
                                    <p>{msg.text}</p>
                                    <p className={`text-[10px] mt-1 ${isMe ? 'text-indigo-400' : 'text-gray-400'}`}>{msg.timestamp?.toDate ? msg.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}</p>
                                </div>
                            );
                        })}
                        <div ref={bottomRef} />
                    </div>
                    <form onSubmit={sendMessage} className="p-3 bg-white border-t border-gray-100 flex gap-2 shrink-0">
                        <input type="text" value={newMessage} onChange={(e) => setNewMessage(e.target.value)} placeholder="Type a message..." className="flex-grow px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
                        <button type="submit" disabled={!newMessage.trim()} className="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"><Send size={18} /></button>
                    </form>
                </div>
            );
        }

        function CommonGrievanceList({ user, role }) {
            const [grievances, setGrievances] = useState([]);
            const [subject, setSubject] = useState('');
            const [description, setDescription] = useState('');
            const [msg, setMsg] = useState('');
            
            useEffect(() => {
                const q = query(collection(db, 'grievances'), where('userId', '==', user.uid));
                const unsub = onSnapshot(q, (s) => setGrievances(s.docs.map(d => ({id:d.id, ...d.data()}))));
                return () => unsub();
            }, [user.uid]);

            const submitGrievance = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'grievances'), {
                    userId: user.uid,
                    userEmail: user.email,
                    userName: user.displayName || user.email,
                    userRole: role,
                    subject,
                    description,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                setSubject(''); setDescription(''); 
                setMsg("Grievance submitted successfully.");
                setTimeout(() => setMsg(''), 3000);
            };

            return (
                <div className="space-y-6">
                    <Card className="p-6">
                        <h3 className="font-bold mb-4">Submit Grievance</h3>
                        {msg && <div className="mb-4 p-3 bg-green-50 text-green-700 rounded-lg text-sm">{msg}</div>}
                        <form onSubmit={submitGrievance} className="space-y-4">
                            <input className="w-full p-2 border rounded" placeholder="Subject" value={subject} onChange={e=>setSubject(e.target.value)} required />
                            <textarea className="w-full p-2 border rounded" rows={3} placeholder="Describe your issue..." value={description} onChange={e=>setDescription(e.target.value)} required />
                            <Button type="submit">Submit</Button>
                        </form>
                    </Card>
                    <Card className="p-6">
                        <h3 className="font-bold mb-4">My Grievances</h3>
                        <div className="space-y-2">
                            {grievances.map(g => (
                                <div key={g.id} className="p-3 border rounded bg-gray-50">
                                    <div className="flex justify-between font-bold"><span>{g.subject}</span><Badge color={g.status==='resolved'?'green':'red'}>{g.status}</Badge></div>
                                    <p className="text-sm mt-1">{g.description}</p>
                                </div>
                            ))}
                            {grievances.length===0 && <p className="text-gray-500">No records found.</p>}
                        </div>
                    </Card>
                </div>
            );
        }

        function Home({ user, onNavigate }) {
            const [news, setNews] = useState([]);
            useEffect(() => {
                const unsubscribe = onSnapshot(query(collection(db, 'news'), orderBy('createdAt', 'desc')), 
                    (snapshot) => setNews(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))), 
                    (error) => console.error("News error:", error)
                );
                return () => unsubscribe();
            }, []);

            return (
                <div className="space-y-12">
                    <section className="text-center space-y-6 py-12">
                        <h1 className="text-4xl md:text-6xl font-extrabold text-gray-900 tracking-tight">Empowering the <span className="text-indigo-600">Queer Community</span></h1>
                        <p className="max-w-2xl mx-auto text-lg md:text-xl text-gray-600">Connecting you with inclusive services, supportive organizations, and a community that cares.</p>
                        {!user && <div className="flex justify-center gap-4"><Button onClick={() => onNavigate('signup')} className="!text-lg !px-8 !py-3">Get Started</Button><Button variant="secondary" onClick={() => onNavigate('login')} className="!text-lg !px-8 !py-3">Sign In</Button></div>}
                    </section>
                    
                    {/* Mission & Vision */}
                    <div className="grid md:grid-cols-2 gap-8">
                        <Card className="p-8 bg-gradient-to-br from-indigo-50 to-white border-indigo-100">
                            <div className="flex items-center gap-3 mb-4"><div className="p-2 bg-indigo-100 rounded-lg text-indigo-600"><Heart size={24} /></div><h2 className="text-2xl font-bold text-gray-900">Our Mission</h2></div>
                            <p className="text-gray-600 leading-relaxed">To provide a safe, accessible, and affirmative platform for Queer individuals to access essential services.</p>
                        </Card>
                        <Card className="p-8 bg-gradient-to-br from-purple-50 to-white border-purple-100">
                            <div className="flex items-center gap-3 mb-4"><div className="p-2 bg-purple-100 rounded-lg text-purple-600"><Shield size={24} /></div><h2 className="text-2xl font-bold text-gray-900">Our Vision</h2></div>
                            <p className="text-gray-600 leading-relaxed">A world where every Queer individual has equal access to healthcare, legal aid, housing, and community support.</p>
                        </Card>
                    </div>

                    {/* Services Section */}
                    <section className="py-8">
                        <div className="text-center mb-8">
                          <h2 className="text-3xl font-bold text-gray-900">Our Services</h2>
                          <p className="text-gray-600 mt-2">Holistic support for the community.</p>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                          {[
                            { icon: BookOpen, title: "Skill Development", desc: "Training programs to enhance your professional skillset." },
                            { icon: Briefcase, title: "Employment", desc: "Connecting you with inclusive employers and job opportunities." },
                            { icon: Users, title: "Inclusivity Workshops", desc: "Sensitization and awareness sessions for organizations." },
                            { icon: Heart, title: "Mental Health", desc: "Counseling and support groups for emotional well-being." }
                          ].map((s, i) => (
                            <Card key={i} className="p-6 text-center hover:shadow-md transition-shadow">
                              <div className="w-12 h-12 mx-auto bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 mb-4">
                                <s.icon size={24} />
                              </div>
                              <h3 className="font-bold text-lg text-gray-900 mb-2">{s.title}</h3>
                              <p className="text-sm text-gray-600">{s.desc}</p>
                            </Card>
                          ))}
                        </div>
                    </section>

                    <section>
                        <div className="flex items-center gap-3 mb-6"><Newspaper className="text-indigo-600" /><h2 className="text-2xl font-bold text-gray-900">Latest Updates</h2></div>
                        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                            {news.length > 0 ? news.map(item => (
                                <Card key={item.id} className="p-6 flex flex-col h-full hover:shadow-md transition-shadow">
                                    <div className="mb-4"><span className="text-xs font-medium text-gray-500">{item.createdAt?.toDate ? item.createdAt.toDate().toLocaleDateString() : 'Just now'}</span><h3 className="text-xl font-bold text-gray-900 mt-1">{item.title}</h3></div>
                                    <p className="text-gray-600 text-sm flex-grow whitespace-pre-wrap">{item.content}</p>
                                </Card>
                            )) : <div className="col-span-full text-center py-12 bg-gray-50 rounded-xl border border-dashed border-gray-300 text-gray-500">No news updates yet. Stay tuned!</div>}
                        </div>
                    </section>
                </div>
            );
        }

        function Login({ onNavigate }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const handleLogin = async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, email, password); onNavigate('home'); } catch (err) { setError("Failed to login. Please check your credentials."); } };
            return (
                <div className="max-w-md mx-auto mt-12">
                    <Card className="p-8">
                        <div className="text-center mb-8"><h2 className="text-2xl font-bold text-gray-900">Welcome Back</h2><p className="text-gray-500 mt-2">Sign in to your account</p></div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            {error && <div className="p-3 bg-red-50 text-red-700 text-sm rounded-lg">{error}</div>}
                            <input type="email" placeholder="Email Address" required className="w-full px-4 py-2 rounded-lg border border-gray-300 outline-none focus:ring-2 focus:ring-indigo-500" value={email} onChange={(e) => setEmail(e.target.value)} />
                            <input type="password" placeholder="Password" required className="w-full px-4 py-2 rounded-lg border border-gray-300 outline-none focus:ring-2 focus:ring-indigo-500" value={password} onChange={(e) => setPassword(e.target.value)} />
                            <Button type="submit" className="w-full">Sign In</Button>
                        </form>
                        <p className="text-center mt-6 text-sm text-gray-600">Don't have an account? <button onClick={() => onNavigate('signup')} className="text-indigo-600 font-medium hover:underline">Sign up</button></p>
                    </Card>
                </div>
            );
        }

        function Signup({ onNavigate }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [agreed, setAgreed] = useState(false);
            const [showTerms, setShowTerms] = useState(false);
            
            const handleSignup = async (e) => { 
                e.preventDefault(); 
                if (!agreed) {
                    setError("You must agree to the Terms and Conditions to create an account.");
                    return;
                }
                try { 
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password); 
                    
                    // Create User DB Entry 
                    await setDoc(doc(db, 'users', userCredential.user.uid), { 
                        uid: userCredential.user.uid, 
                        email, 
                        displayName: name, 
                        role: 'user', 
                        isActive: true, 
                        termsAccepted: true,
                        termsAcceptedAt: serverTimestamp(),
                        createdAt: serverTimestamp(),
                        lastSeen: serverTimestamp() // Set initial lastSeen
                    }); 

                    // Send verification email immediately for new users
                    await sendEmailVerification(userCredential.user);
                    alert("Account created! We've sent a verification email to " + email + ". Please verify it to access your dashboard.");

                    onNavigate('home'); 
                } catch (err) { 
                    setError(err.message); 
                } 
            };

            return (
                <div className="max-w-md mx-auto mt-12">
                    <Card className="p-8">
                        <div className="text-center mb-8"><h2 className="text-2xl font-bold text-gray-900">Join Shades of Hue</h2><p className="text-gray-500 mt-2">Create your account today</p></div>
                        <form onSubmit={handleSignup} className="space-y-6">
                            {error && <div className="p-3 bg-red-50 text-red-700 text-sm rounded-lg">{error}</div>}
                            <input type="text" placeholder="Full Name" required className="w-full px-4 py-2 rounded-lg border border-gray-300 outline-none focus:ring-2 focus:ring-indigo-500" value={name} onChange={(e) => setName(e.target.value)} />
                            <input type="email" placeholder="Email Address" required className="w-full px-4 py-2 rounded-lg border border-gray-300 outline-none focus:ring-2 focus:ring-indigo-500" value={email} onChange={(e) => setEmail(e.target.value)} />
                            <input type="password" placeholder="Password (min 6 chars)" required minLength={6} className="w-full px-4 py-2 rounded-lg border border-gray-300 outline-none focus:ring-2 focus:ring-indigo-500" value={password} onChange={(e) => setPassword(e.target.value)} />
                            
                            <div className="flex items-start gap-2 text-sm text-gray-600 px-1">
                                <input 
                                    type="checkbox" 
                                    id="terms" 
                                    checked={agreed} 
                                    onChange={(e) => setAgreed(e.target.checked)}
                                    className="mt-1"
                                />
                                <label htmlFor="terms">
                                    I agree to the <button type="button" onClick={() => setShowTerms(true)} className="text-indigo-600 hover:underline font-medium">Terms and Conditions</button>
                                </label>
                            </div>

                            <Button type="submit" className="w-full">Sign Up</Button>
                        </form>
                        <p className="text-center mt-6 text-sm text-gray-600">Already have an account? <button onClick={() => onNavigate('login')} className="text-indigo-600 font-medium hover:underline">Sign in</button></p>
                    </Card>
                    {showTerms && <TermsModal onClose={() => setShowTerms(false)} />}
                </div>
            );
        }

        // --- SUB-COMPONENTS FOR ADMIN DASHBOARD ---
        function AdminRequestMonitor() {
            const [requests, setRequests] = useState([]);
            
            useEffect(() => {
                const q = query(collection(db, 'requests'), orderBy('createdAt', 'desc'));
                const unsub = onSnapshot(q, (s) => {
                    const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    setRequests(data);
                });
                return () => unsub();
            }, []);

            return (
                <Card className="p-6">
                    <h3 className="font-bold text-gray-900 mb-6 flex items-center gap-2">
                        <Activity size={20} className="text-indigo-600" /> Request Monitor
                    </h3>
                    <div className="space-y-4">
                        {requests.map(req => (
                            <div key={req.id} className="p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                                <div className="flex flex-col md:flex-row justify-between items-start gap-4">
                                    <div className="flex-grow">
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="font-bold text-gray-900 text-lg">{req.serviceName}</span>
                                            <Badge color={req.status==='accepted'?'green':req.status==='declined'?'red':req.status==='in_progress'?'yellow':req.status==='completed'?'green':req.status==='cancelled'?'gray':'blue'}>
                                                {req.status === 'payment_review' ? 'Payment Review' : req.status}
                                            </Badge>
                                        </div>
                                        <div className="text-sm text-gray-600 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1 mt-2">
                                            <span><strong>User:</strong> {req.userName} ({req.userEmail})</span>
                                            <span><strong>Org:</strong> {req.orgName}</span>
                                            <span><strong>Price:</strong> {req.servicePrice ? `${req.servicePrice}` : 'Free'}</span>
                                            <span><strong>Date:</strong> {req.createdAt?.toDate ? req.createdAt.toDate().toLocaleDateString() : 'N/A'}</span>
                                        </div>
                                        
                                        {/* Show Decline Reason */}
                                        {req.status === 'declined' && req.declineReason && (
                                            <div className="mt-3 p-3 bg-red-50 border border-red-100 rounded text-sm text-red-800">
                                                <strong>Reason for Decline:</strong> {req.declineReason}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                        {requests.length === 0 && <div className="text-center text-gray-500 py-8">No requests found in the system.</div>}
                    </div>
                </Card>
            );
        }

        function AdminUserList() {
            const [users, setUsers] = useState([]);
            const [confirmingId, setConfirmingId] = useState(null);
            
            useEffect(() => { 
                const unsub = onSnapshot(collection(db, 'users'), (s) => {
                    const data = s.docs.map(d => ({id:d.id, ...d.data()}));
                    data.sort((a,b) => {
                        if (a.isActive !== b.isActive) return a.isActive ? -1 : 1;
                        const timeA = a.lastSeen?.seconds || 0;
                        const timeB = b.lastSeen?.seconds || 0;
                        return timeB - timeA;
                    });
                    setUsers(data);
                }); 
                return () => unsub(); 
            }, []);

            const toggleStatus = async (uid, status) => { await updateDoc(doc(db, 'users', uid), { isActive: !status }); };
            const deleteUser = async (uid) => { if (confirmingId === uid) { await deleteDoc(doc(db, 'users', uid)); setConfirmingId(null); } else { setConfirmingId(uid); setTimeout(() => setConfirmingId(null), 3000); } };
            
            return (
                <Card className="p-6"><h3 className="text-xl font-bold text-gray-900 mb-6">User Management</h3><div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead><tr className="border-b text-gray-500"><th>User</th><th>Role</th><th>Online Status</th><th>Last Seen</th><th>Account Status</th><th className="text-right">Actions</th></tr></thead><tbody className="divide-y">{users.map(u => {
                    const now = new Date();
                    const lastSeen = u.lastSeen?.toDate ? u.lastSeen.toDate() : new Date(0);
                    const diff = (now - lastSeen) / 1000 / 60; 
                    const isOnline = diff < 2;

                    return (
                        <tr key={u.id} className={!u.isActive ? "bg-amber-50" : ""}>
                            <td className="py-3">
                                <div className="font-medium">{u.displayName}</div>
                                <div className="text-xs text-gray-500">{u.email}</div>
                            </td>
                            <td className="capitalize"><Badge color={u.role==='admin'?'purple':u.role==='organization'?'blue':'gray'}>{u.role}</Badge></td>
                            <td>
                                {isOnline ? (
                                    <span className="flex items-center gap-1.5 text-green-700 font-medium text-xs bg-green-50 px-2 py-1 rounded-full w-fit">
                                        <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Online
                                    </span>
                                ) : (
                                    <span className="flex items-center gap-1.5 text-gray-500 text-xs px-2 py-1">
                                        <span className="w-2 h-2 rounded-full bg-gray-300"></span> Offline
                                    </span>
                                )}
                            </td>
                            <td className="text-xs text-gray-500">
                                {u.lastSeen?.toDate ? u.lastSeen.toDate().toLocaleString([], {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}) : 'Never'}
                            </td>
                            <td>{u.isActive?<span className="text-green-600 flex items-center gap-1"><CheckCircle size={14}/> Active</span>:<span className="text-amber-600 flex items-center gap-1"><Clock size={14}/> Pending</span>}</td>
                            <td className="text-right space-x-2">{!SUPER_ADMINS.includes(u.email) && <><button onClick={()=>toggleStatus(u.id, u.isActive)} className={!u.isActive ? "text-green-600 hover:bg-green-100 p-1 rounded" : "text-gray-400"} title={u.isActive ? "Deactivate" : "Approve"}>{u.isActive ? <XCircle size={16}/> : <CheckCircle size={16}/>}</button><button onClick={()=>deleteUser(u.id)} className={confirmingId === u.id ? "text-red-600 font-bold" : "text-gray-400 hover:text-red-600"}>{confirmingId === u.id ? "Sure?" : <Trash2 size={16}/>}</button></>}</td>
                        </tr>
                    );
                })}</tbody></table></div></Card>
            );
        }

        function AdminCreateUser() {
            const [form, setForm] = useState({email:'', password:'', name:'', role:'organization'});
            const [msg, setMsg] = useState({type:'', text:''});
            const handleCreate = async (e) => {
                e.preventDefault(); setMsg({type:'info', text:'Creating...'});
                try {
                    const secondaryApp = initializeApp(firebaseConfig, "Secondary");
                    const secAuth = getAuth(secondaryApp);
                    const cred = await createUserWithEmailAndPassword(secAuth, form.email, form.password);
                    await setDoc(doc(db, 'users', cred.user.uid), { 
                        uid: cred.user.uid, 
                        email: form.email, 
                        displayName: form.name, 
                        role: form.role, 
                        isActive: true, 
                        createdAt: serverTimestamp(), 
                        lastSeen: serverTimestamp(),
                        ...(form.role==='organization'?{description:'New Org', services:[]}:{}) 
                    });
                    await signOut(secAuth);
                    setMsg({type:'success', text:'Created!'}); setForm({email:'', password:'', name:'', role:'organization'});
                } catch(err) { setMsg({type:'error', text:err.message}); }
            };
            return (
                <Card className="p-8 max-w-xl mx-auto"><h3 className="text-xl font-bold mb-6">Create Account</h3><form onSubmit={handleCreate} className="space-y-4">{msg.text && <div className={`p-2 text-sm rounded ${msg.type==='error'?'bg-red-50 text-red-700':'bg-green-50 text-green-700'}`}>{msg.text}</div>}<div className="flex gap-4 mb-2"><label className="flex items-center gap-2"><input type="radio" checked={form.role==='organization'} onChange={()=>setForm({...form, role:'organization'})} /> Org</label><label className="flex items-center gap-2"><input type="radio" checked={form.role==='admin'} onChange={()=>setForm({...form, role:'admin'})} /> Admin</label></div><input className="w-full p-2 border rounded" placeholder="Name" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} required /><input className="w-full p-2 border rounded" placeholder="Email" type="email" value={form.email} onChange={e=>setForm({...form, email:e.target.value})} required /><input className="w-full p-2 border rounded" placeholder="Password" type="password" value={form.password} onChange={e=>setForm({...form, password:e.target.value})} required /><Button type="submit" className="w-full">Create</Button></form></Card>
            );
        }

        function AdminNewsManager() {
            const [news, setNews] = useState({title:'', content:''});
            const [newsList, setNewsList] = useState([]);
            const [confirmId, setConfirmId] = useState(null);
            useEffect(() => { const q = query(collection(db, 'news'), orderBy('createdAt', 'desc')); const unsub = onSnapshot(q, (s) => setNewsList(s.docs.map(d => ({ id: d.id, ...d.data() })))); return () => unsub(); }, []);
            const post = async (e) => { e.preventDefault(); try { await addDoc(collection(db, 'news'), {...news, createdAt: serverTimestamp()}); setNews({title:'', content:''}); } catch (e) { console.error(e); } };
            const deleteNews = async (id) => { if (confirmId === id) { await deleteDoc(doc(db, 'news', id)); setConfirmId(null); } else { setConfirmId(id); setTimeout(() => setConfirmId(null), 3000); } };
            return (
                <div className="space-y-8"><Card className="p-6"><h3 className="font-bold mb-4">Post News</h3><form onSubmit={post} className="space-y-4"><input className="w-full p-2 border rounded" placeholder="Title" value={news.title} onChange={e=>setNews({...news, title:e.target.value})} required /><textarea className="w-full p-2 border rounded" rows={3} placeholder="Content" value={news.content} onChange={e=>setNews({...news, content:e.target.value})} required /><Button type="submit">Publish</Button></form></Card><Card className="p-6"><h3 className="font-bold mb-4">Manage Updates</h3><div className="space-y-4">{newsList.map(item => (<div key={item.id} className="p-4 border rounded bg-gray-50 flex justify-between items-start group"><div><h4 className="font-bold text-gray-900">{item.title}</h4><p className="text-sm text-gray-600 mt-1 whitespace-pre-wrap">{item.content}</p><div className="text-xs text-gray-400 mt-2">{item.createdAt?.toDate ? item.createdAt.toDate().toLocaleDateString() : 'Just now'}</div></div><button onClick={() => deleteNews(item.id)} className={`p-2 rounded transition-colors ${confirmId === item.id ? 'bg-red-50 text-red-600' : 'text-gray-400 hover:text-red-600 hover:bg-gray-100'}`} title="Delete">{confirmId === item.id ? <span className="text-xs font-bold">Sure?</span> : <Trash2 size={18} />}</button></div>))}{newsList.length === 0 && <p className="text-gray-500 text-sm">No updates posted.</p>}</div></Card></div>
            );
        }

        function AdminPaymentApprovals() {
            const [requests, setRequests] = useState([]);
            const [confirmingId, setConfirmingId] = useState(null);
            useEffect(() => { const q = query(collection(db, 'requests'), where('status', '==', 'payment_review')); const unsub = onSnapshot(q, (s) => { const data = s.docs.map(d => ({ id: d.id, ...d.data() })); data.sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds); setRequests(data); }); return () => unsub(); }, []);
            const handleClick = (id) => { if (confirmingId === id) { approvePayment(id); } else { setConfirmingId(id); setTimeout(() => setConfirmingId(null), 3000); } };
            const approvePayment = async (id) => { try { await updateDoc(doc(db, 'requests', id), { status: 'pending' }); setConfirmingId(null); } catch (e) { console.error(e); } };
            return (
                <Card className="p-6"><h3 className="font-bold text-gray-900 mb-6 flex items-center gap-2"><IndianRupee size={20} className="text-indigo-600" /> Payment Approvals</h3><div className="space-y-3">{requests.map(req => (<div key={req.id} className="p-4 border border-indigo-100 rounded-lg bg-indigo-50/50 flex flex-col md:flex-row justify-between items-center gap-4"><div><div className="font-bold text-gray-900">{req.serviceName} <span className="text-gray-500 font-normal">({req.servicePrice || 'N/A'})</span></div><div className="text-sm text-gray-600">User: {req.userEmail}</div><div className="text-xs text-gray-400 mt-1">To: {req.orgName}</div></div><Button onClick={() => handleClick(req.id)} variant={confirmingId === req.id ? 'danger' : 'success'} className="!py-1.5 !px-4 !text-sm transition-all">{confirmingId === req.id ? 'Confirm Approval?' : <><Check size={16} /> Approve Payment</>}</Button></div>))}{requests.length === 0 && <p className="text-gray-500 text-center py-4">No pending payments.</p>}</div></Card>
            );
        }

        function AdminGrievances() {
            const [grievances, setGrievances] = useState([]);
            useEffect(() => {
                const q = query(collection(db, 'grievances'));
                const unsub = onSnapshot(q, (s) => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    data.sort((a,b) => b.createdAt?.seconds - a.createdAt?.seconds);
                    setGrievances(data);
                });
                return () => unsub();
            }, []);

            const resolveGrievance = async (id) => {
                await updateDoc(doc(db, 'grievances', id), { status: 'resolved' });
            };

            return (
                <Card className="p-6"><h3 className="font-bold text-gray-900 mb-6 flex items-center gap-2"><AlertTriangle size={20} className="text-amber-600" /> Grievance Portal</h3><div className="space-y-4">{grievances.map(g => (
                    <div key={g.id} className="p-4 border border-gray-200 rounded-lg">
                        <div className="flex justify-between items-start">
                            <div>
                                <div className="font-bold text-lg">{g.subject} <Badge color={g.status==='resolved'?'green':'red'}>{g.status}</Badge></div>
                                <div className="text-sm text-gray-500 mt-1">From: {g.userEmail} ({g.userRole})</div>
                                <p className="mt-2 text-gray-700">{g.description}</p>
                            </div>
                            {g.status !== 'resolved' && <Button variant="secondary" onClick={() => resolveGrievance(g.id)} className="!py-1 !text-sm">Mark Resolved</Button>}
                        </div>
                    </div>
                ))}
                {grievances.length === 0 && <div className="text-center text-gray-500">No grievances found.</div>}</div></Card>
            );
        }

        function AdminMessageCenter() {
            const [chats, setChats] = useState([]);
            const [selectedChat, setSelectedChat] = useState(null);
            useEffect(() => {
                const q = query(collection(db, 'chats'));
                const unsub = onSnapshot(q, (s) => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    data.sort((a,b) => (b.lastMessageTime?.seconds || 0) - (a.lastMessageTime?.seconds || 0));
                    setChats(data);
                });
                return () => unsub();
            }, []);
            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]"><Card className="col-span-1 flex flex-col h-full"><div className="p-4 border-b"><h3 className="font-bold text-gray-900">Conversations</h3></div><div className="overflow-y-auto flex-1 p-2 space-y-2">{chats.map(chat => (<div key={chat.id} onClick={() => setSelectedChat(chat)} className={`p-3 rounded-lg cursor-pointer border transition-all ${selectedChat?.id === chat.id ? 'bg-indigo-50 border-indigo-200' : 'hover:bg-gray-50 border-transparent'}`}><div className="text-xs font-bold text-gray-700 truncate">{Object.values(chat.participantData || {}).map(p => p.name).join(' & ')}</div><div className="text-xs text-gray-500 truncate mt-1">{chat.lastMessage || 'No messages'}</div><div className="text-[10px] text-gray-400 mt-1 text-right">{chat.lastMessageTime?.toDate ? chat.lastMessageTime.toDate().toLocaleDateString() : ''}</div></div>))}{chats.length === 0 && <div className="p-4 text-center text-gray-500 text-sm">No chats found</div>}</div></Card><Card className="col-span-1 lg:col-span-2 flex flex-col h-full overflow-hidden">{selectedChat ? (<AdminChatDetails chat={selectedChat} />) : (<div className="h-full flex items-center justify-center text-gray-400 bg-gray-50/50">Select a conversation to monitor</div>)}</Card></div>
            );
        }

        function AdminChatDetails({ chat }) {
            const [messages, setMessages] = useState([]);
            const bottomRef = useRef(null);
            useEffect(() => {
                const q = query(collection(db, 'chats', chat.id, 'messages'), orderBy('timestamp', 'asc'));
                const unsub = onSnapshot(q, (s) => {
                    setMessages(s.docs.map(d => ({id: d.id, ...d.data()})));
                    setTimeout(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                });
                return () => unsub();
            }, [chat.id]);
            return (
                <div className="flex flex-col h-full"><div className="p-4 border-b bg-gray-50"><h4 className="font-bold text-gray-800 text-sm">{Object.values(chat.participantData || {}).map(p => `${p.name}`).join('  ')}</h4></div><div className="flex-1 overflow-y-auto p-4 space-y-3 bg-white">{messages.map(m => { const sender = chat.participantData?.[m.senderId]; const senderName = sender ? sender.name : m.senderEmail; return (<div key={m.id} className="flex flex-col"><div className="flex justify-between items-end mb-1"><span className="text-xs font-bold text-indigo-600">{senderName}</span><span className="text-[10px] text-gray-400">{m.timestamp?.toDate ? m.timestamp.toDate().toLocaleTimeString() : ''}</span></div><div className="bg-gray-100 p-3 rounded-lg rounded-tl-none text-sm text-gray-800">{m.text}</div></div>); })}<div ref={bottomRef} /></div></div>
            );
        }

        function AdminFeedbackMonitor() {
            const [feedbackList, setFeedbackList] = useState([]);
            
            useEffect(() => {
                const q = query(collection(db, 'requests'), where('status', '==', 'completed'));
                const unsub = onSnapshot(q, (s) => {
                    const data = s.docs
                        .map(d => ({ id: d.id, ...d.data() }))
                        .filter(item => item.feedback) 
                        .sort((a, b) => (b.feedback?.createdAt?.seconds || 0) - (a.feedback?.createdAt?.seconds || 0));
                    setFeedbackList(data);
                });
                return () => unsub();
            }, []);

            return (
                <Card className="p-6">
                    <h3 className="font-bold text-gray-900 mb-6 flex items-center gap-2">
                        <Star size={20} className="text-yellow-500" /> Service Feedback Monitor
                    </h3>
                    <div className="space-y-4">
                        {feedbackList.map(item => (
                            <div key={item.id} className="p-4 border border-gray-200 rounded-lg bg-gray-50">
                                <div className="flex flex-col md:flex-row justify-between md:items-start gap-4">
                                    <div>
                                        <div className="font-bold text-gray-900 flex items-center gap-2">
                                            {item.serviceName} 
                                            <span className="text-gray-400 font-normal text-sm">by {item.orgName}</span>
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">User: {item.userName}</div>
                                        <div className="mt-3">
                                            <StarRating rating={item.feedback.rating} />
                                            <p className="mt-2 text-sm text-gray-700 italic">"{item.feedback.comment}"</p>
                                        </div>
                                    </div>
                                    <div className="text-xs text-gray-400 whitespace-nowrap">
                                        {item.feedback.createdAt?.toDate ? item.feedback.createdAt.toDate().toLocaleDateString() : 'Recent'}
                                    </div>
                                </div>
                            </div>
                        ))}
                        {feedbackList.length === 0 && <div className="text-center text-gray-500 py-8">No feedback submitted yet.</div>}
                    </div>
                </Card>
            );
        }

        // --- ADMIN DASHBOARD ---
        function AdminDashboard({ user }) {
            const [activeTab, setActiveTab] = useState('users');
            const SidebarBtn = ({ icon: Icon, label, active, onClick }) => <button onClick={onClick} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'}`}><Icon size={18} />{label}</button>;
            return (
                <div className="grid lg:grid-cols-4 gap-8">
                    <div className="lg:col-span-1 space-y-4">
                        <Card className="p-4"><h3 className="font-bold text-gray-900 mb-4 px-2">Admin Controls</h3><div className="space-y-1">
                            <SidebarBtn icon={User} label="Manage Users" active={activeTab === 'users'} onClick={() => setActiveTab('users')} />
                            <SidebarBtn icon={Plus} label="Create Account" active={activeTab === 'create'} onClick={() => setActiveTab('create')} />
                            <SidebarBtn icon={Newspaper} label="Manage News" active={activeTab === 'news'} onClick={() => setActiveTab('news')} />
                            <SidebarBtn icon={IndianRupee} label="Payment Approvals" active={activeTab === 'approvals'} onClick={() => setActiveTab('approvals')} />
                            <SidebarBtn icon={Activity} label="Request Monitor" active={activeTab === 'monitor'} onClick={() => setActiveTab('monitor')} />
                            <SidebarBtn icon={AlertTriangle} label="Grievance Portal" active={activeTab === 'grievances'} onClick={() => setActiveTab('grievances')} />
                            <SidebarBtn icon={MessageSquare} label="Conversation Monitor" active={activeTab === 'messages'} onClick={() => setActiveTab('messages')} />
                            <SidebarBtn icon={Star} label="Service Feedback" active={activeTab === 'feedback'} onClick={() => setActiveTab('feedback')} />
                        </div></Card>
                    </div>
                    <div className="lg:col-span-3">
                        {activeTab === 'users' && <AdminUserList />} 
                        {activeTab === 'create' && <AdminCreateUser />} 
                        {activeTab === 'news' && <AdminNewsManager />} 
                        {activeTab === 'approvals' && <AdminPaymentApprovals />} 
                        {activeTab === 'monitor' && <AdminRequestMonitor />}
                        {activeTab === 'grievances' && <AdminGrievances />} 
                        {activeTab === 'messages' && <AdminMessageCenter />} 
                        {activeTab === 'feedback' && <AdminFeedbackMonitor />}
                    </div>
                </div>
            );
        }

        // --- SUB-COMPONENTS FOR ORG DASHBOARD ---
        function OrgChatList({ user, onSelectChat }) {
            const [chats, setChats] = useState([]);
            useEffect(() => {
                const q = query(collection(db, 'chats'), where('participants', 'array-contains', user.uid));
                const unsub = onSnapshot(q, (s) => {
                    const chatData = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    chatData.sort((a, b) => {
                        const timeA = a.lastMessageTime?.toMillis ? a.lastMessageTime.toMillis() : 0;
                        const timeB = b.lastMessageTime?.toMillis ? b.lastMessageTime.toMillis() : 0;
                        return timeB - timeA;
                    });
                    setChats(chatData);
                });
                return () => unsub();
            }, [user.uid]);
            
            const getPartnerName = (chat) => { 
                const partnerId = chat.participants.find(p => p !== user.uid); 
                const pData = chat.participantData?.[partnerId];
                return pData?.name || "User"; 
            };
            
            return (<Card className="p-6"><h3 className="font-bold mb-4">Conversations</h3><div className="space-y-2">{chats.length > 0 ? chats.map(chat => (<div key={chat.id} onClick={() => onSelectChat(chat.id)} className="p-4 border rounded hover:bg-gray-50 cursor-pointer transition-colors"><div className="flex justify-between items-start"><span className="font-bold text-gray-900">{getPartnerName(chat)}</span><span className="text-xs text-gray-400">{chat.lastMessageTime?.toDate ? chat.lastMessageTime.toDate().toLocaleDateString() : ''}</span></div><p className="text-sm text-gray-600 truncate mt-1">{chat.lastMessage || "No messages yet"}</p></div>)) : <p className="text-gray-500 text-center py-4">No active conversations.</p>}</div></Card>);
        }

        // --- ORG DASHBOARD ---
        function OrgDashboard({ user, userData }) {
            const [tab, setTab] = useState('profile');
            const [isEditing, setIsEditing] = useState(false);
            const [data, setData] = useState({ desc: userData?.description||'', services: userData?.services||[], newServiceName:'', newServicePrice: '', newServiceDesc: '' });
            const [requests, setRequests] = useState([]);
            const [activeChatId, setActiveChatId] = useState(null);
            
            // Logic for Accepting
            const [confirmingReqId, setConfirmingReqId] = useState(null);
            
            // Logic for Declining
            const [declineModalReqId, setDeclineModalReqId] = useState(null);

            // Profile Edit States
            const [profileName, setProfileName] = useState(userData?.displayName || '');
            const [profileEmail, setProfileEmail] = useState(user.email || '');
            const [profileMsg, setProfileMsg] = useState({type:'', text:''});

            // Password Edit States
            const [pass, setPass] = useState('');
            const [confirm, setConfirm] = useState('');
            const [passMsg, setPassMsg] = useState({type:'', text:''});

            useEffect(() => { 
                if(userData) {
                    setData(d => ({...d, desc: userData.description||'', services: userData.services||[] }));
                    setProfileName(userData.displayName || '');
                } 
                if(user) setProfileEmail(user.email);
            }, [userData, user]);

            useEffect(() => {
                const unsub = onSnapshot(query(collection(db, 'requests'), where('orgId', '==', user.uid)), (snapshot) => {
                    const allRequests = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setRequests(allRequests.filter(r => r.status !== 'payment_review'));
                }, (e)=>console.error(e)); return () => unsub();
            }, [user.uid]);

            const saveProfile = async () => { await updateDoc(doc(db, 'users', user.uid), { description: data.desc, services: data.services }); setIsEditing(false); };
            
            const handleAcceptToggle = (id) => { 
                const actionId = `${id}-accepted`; 
                if (confirmingReqId === actionId) { 
                    updateRequestStatus(id, 'accepted'); 
                } else { 
                    setConfirmingReqId(actionId); 
                    setTimeout(() => setConfirmingReqId(null), 3000); 
                } 
            };

            const updateRequestStatus = async (id, status, extraData = {}) => {
                try {
                    await updateDoc(doc(db, 'requests', id), { status, ...extraData });
                    setConfirmingReqId(null);
                } catch (e) {
                    console.error("Error updating status:", e);
                }
            };

            const onDeclineSubmit = async (reason) => {
                if(declineModalReqId) {
                    await updateRequestStatus(declineModalReqId, 'declined', { declineReason: reason });
                    setDeclineModalReqId(null);
                }
            };

            const handleStatusChange = async (id, newStatus) => {
                await updateRequestStatus(id, newStatus);
            };

            const handleAddService = () => { if(data.newServiceName) { const newServiceObj = { name: data.newServiceName, price: data.newServicePrice, description: data.newServiceDesc }; setData({ ...data, services: [...data.services, newServiceObj], newServiceName: '', newServicePrice: '', newServiceDesc: '' }); } };

            const handleUpdateOrgInfo = async (e) => {
                e.preventDefault();
                setProfileMsg({type:'', text:''});
                try {
                    if(profileName !== userData.displayName) {
                        await updateProfile(user, { displayName: profileName });
                        await updateDoc(doc(db, 'users', user.uid), { displayName: profileName });
                    }
                    if(profileEmail !== user.email) {
                        await updateEmail(user, profileEmail);
                        await updateDoc(doc(db, 'users', user.uid), { email: profileEmail });
                        setProfileMsg({type:'success', text:'Profile updated. If you changed your email, please login again.'});
                    } else {
                        setProfileMsg({type:'success', text:'Profile updated successfully!'});
                    }
                } catch(error) {
                    if(error.code === 'auth/requires-recent-login') {
                        setProfileMsg({type:'error', text:'Security: Please log out and log in again to update email.'});
                    } else {
                        setProfileMsg({type:'error', text: error.message});
                    }
                }
            };

            const handleUpdatePassword = async (e) => {
                e.preventDefault();
                if (pass !== confirm) { setPassMsg({ type: 'error', text: 'Passwords do not match' }); return; }
                try {
                    await updatePassword(user, pass);
                    setPassMsg({ type: 'success', text: 'Password updated successfully!' });
                    setPass(''); setConfirm('');
                } catch (error) {
                    setPassMsg({ type: 'error', text: error.code === 'auth/requires-recent-login' ? 'Security: Please log out and login again to update password.' : error.message });
                }
            };

            return (
                <div className="grid lg:grid-cols-4 gap-8">
                    <div className="lg:col-span-1 space-y-4"><Card className="p-4"><h3 className="font-bold text-gray-900 mb-4 px-2">Menu</h3><div className="space-y-1"><button onClick={()=>setTab('profile')} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${tab==='profile'?'bg-indigo-50 text-indigo-700':'text-gray-600 hover:bg-gray-50'}`}><Building2 size={18} /> Profile</button><button onClick={()=>setTab('requests')} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${tab==='requests'?'bg-indigo-50 text-indigo-700':'text-gray-600 hover:bg-gray-50'}`}><CheckCircle size={18} /> Requests</button><button onClick={()=>setTab('messages')} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${tab==='messages'?'bg-indigo-50 text-indigo-700':'text-gray-600 hover:bg-gray-50'}`}><MessageCircle size={18} /> Messages</button><button onClick={()=>setTab('grievances')} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${tab==='grievances'?'bg-indigo-50 text-indigo-700':'text-gray-600 hover:bg-gray-50'}`}><AlertTriangle size={18} /> Grievances</button></div></Card></div>
                    <div className="lg:col-span-3">
                        {tab === 'profile' && (
                            <div className="space-y-6">
                                <Card className="p-6">
                                    <div className="flex justify-between mb-6"><h2 className="text-xl font-bold">Services & Description</h2><Button variant={isEditing?'success':'secondary'} onClick={isEditing?saveProfile:()=>setIsEditing(true)} className="!py-1 !text-sm">{isEditing?'Save':'Edit'}</Button></div>
                                    <div className="space-y-4"><div><label className="block text-sm font-medium mb-1">About</label>{isEditing ? <textarea className="w-full p-2 border rounded" rows={3} value={data.desc} onChange={e=>setData({...data, desc:e.target.value})} /> : <p className="bg-gray-50 p-3 rounded text-gray-700">{data.desc || "No description."}</p>}</div><div><label className="block text-sm font-medium mb-1">Services</label><div className="flex flex-wrap gap-2 mb-2">{data.services.map((s,i) => <span key={i} className="px-2 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs flex items-center gap-1">{typeof s === 'string' ? s : s.name} {s.price && `(${s.price})`}{isEditing && <button onClick={()=>{const n=[...data.services];n.splice(i,1);setData({...data, services:n})}}><X size={12}/></button>}</span>)}</div>{isEditing && <div className="flex flex-col gap-2 mt-2 p-3 bg-gray-50 rounded border"><input className="w-full p-2 border rounded text-sm" placeholder="Service Name" value={data.newServiceName} onChange={e=>setData({...data, newServiceName:e.target.value})} /><div className="flex gap-2"><input className="w-24 p-2 border rounded text-sm" type="number" placeholder="Price ()" value={data.newServicePrice} onChange={e=>setData({...data, newServicePrice:e.target.value})} /><input className="flex-grow p-2 border rounded text-sm" placeholder="Short Description" value={data.newServiceDesc} onChange={e=>setData({...data, newServiceDesc:e.target.value})} /></div><Button variant="secondary" onClick={handleAddService} className="w-full text-xs">Add Service</Button></div>}</div></div>
                                </Card>
                                <Card className="p-6">
                                    <h3 className="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2"><Settings size={20} /> Account Settings</h3>
                                    <form onSubmit={handleUpdateOrgInfo} className="space-y-4 max-w-md">
                                        {profileMsg.text && <div className={`p-3 text-sm rounded ${profileMsg.type==='success'?'bg-green-50 text-green-700':'bg-red-50 text-red-700'}`}>{profileMsg.text}</div>}
                                        <div><label className="block text-sm font-medium">Organization Name</label><input className="w-full p-2 border rounded" value={profileName} onChange={e=>setProfileName(e.target.value)} /></div>
                                        <div>
                                            <label className="block text-sm font-medium">Email Address</label>
                                            <input 
                                                className="w-full p-2 border rounded bg-gray-100 cursor-not-allowed text-gray-600" 
                                                value={profileEmail} 
                                                readOnly 
                                                disabled
                                                title="Contact support to change email"
                                            />
                                            <p className="text-xs text-gray-400 mt-1">Email cannot be changed.</p>
                                        </div>
                                        <Button type="submit">Update Info</Button>
                                    </form>
                                </Card>
                                <Card className="p-6">
                                    <h3 className="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2"><Lock size={20} className="text-indigo-600" /> Security</h3>
                                    <form onSubmit={handleUpdatePassword} className="space-y-4 max-w-md">
                                        {passMsg.text && <div className={`p-3 text-sm rounded-lg ${passMsg.type === 'success' ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'}`}>{passMsg.text}</div>}
                                        <div><label className="block text-sm font-medium text-gray-700 mb-1">New Password</label><input type="password" className="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" value={pass} onChange={(e) => setPass(e.target.value)} placeholder="Enter new password" /></div>
                                        <div><label className="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label><input type="password" className="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" value={confirm} onChange={(e) => setConfirm(e.target.value)} placeholder="Confirm new password" /></div>
                                        <Button type="submit">Update Password</Button>
                                    </form>
                                </Card>
                            </div>
                        )}
                        {tab === 'requests' && (
                            <Card className="p-6">
                                <h3 className="font-bold mb-4">Requests</h3>
                                <div className="space-y-3">
                                    {requests.map(r => (
                                        <div key={r.id} className="p-4 border rounded bg-white flex flex-col gap-3">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <div className="font-bold">{r.serviceName} {r.servicePrice && <span className="text-gray-500 font-normal text-xs">({r.servicePrice})</span>}</div>
                                                    {/* HIDE EMAIL: Display Name instead */}
                                                    <div className="text-sm text-gray-500">{r.userName || "User"}</div>
                                                    <Badge color={r.status==='accepted'?'green':r.status==='declined'?'red':r.status==='in_progress'?'yellow':r.status==='completed'?'green':r.status==='cancelled'?'gray':'blue'}>{r.status}</Badge>
                                                </div>
                                                {r.status === 'pending' && (
                                                    <div className="flex gap-2">
                                                        <Button onClick={()=>handleAcceptToggle(r.id)} variant={confirmingReqId === `${r.id}-accepted` ? 'primary' : 'success'} className="!py-1 transition-all">{confirmingReqId === `${r.id}-accepted` ? 'Confirm?' : 'Accept'}</Button>
                                                        <Button onClick={()=>setDeclineModalReqId(r.id)} variant="secondary" className="!py-1 transition-all">Decline</Button>
                                                    </div>
                                                )}
                                                {['accepted', 'in_progress', 'completed'].includes(r.status) && (
                                                    <div className="mt-2 md:mt-0">
                                                        <select value={r.status} onChange={(e) => handleStatusChange(r.id, e.target.value)} className="text-sm border rounded px-2 py-1 outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                                                            <option value="accepted">Not Started</option>
                                                            <option value="in_progress">In Progress</option>
                                                            <option value="completed">Completed</option>
                                                        </select>
                                                    </div>
                                                )}
                                                {r.status === 'cancelled' && <span className="text-sm text-gray-500 italic">Cancelled by User</span>}
                                                {r.status === 'declined' && r.declineReason && (
                                                    <div className="text-sm text-red-600 italic bg-red-50 p-2 rounded">
                                                        <strong>Decline Reason:</strong> {r.declineReason}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* Show Feedback to Organization */}
                                            {r.feedback && (
                                                <div className="mt-2 p-3 bg-yellow-50 rounded-lg border border-yellow-100">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="text-xs font-bold text-yellow-800 uppercase tracking-wide">Client Feedback</span>
                                                        <StarRating rating={r.feedback.rating} />
                                                    </div>
                                                    <p className="text-sm text-gray-700 italic">"{r.feedback.comment}"</p>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    {requests.length===0 && <p className="text-gray-500">No requests.</p>}
                                </div>
                            </Card>
                        )}
                        {tab === 'messages' && (<OrgChatList user={user} onSelectChat={setActiveChatId} />)}
                        {tab === 'grievances' && <CommonGrievanceList user={user} role="organization" />}
                    </div>
                    {activeChatId && <ChatWindow chatId={activeChatId} onClose={() => setActiveChatId(null)} currentUser={user} />}
                    {declineModalReqId && <DeclineModal onClose={() => setDeclineModalReqId(null)} onSubmit={onDeclineSubmit} />}
                </div>
            );
        }

        // --- SUB-COMPONENTS FOR USER DASHBOARD ---
        function UserProfile({ user, userData }) {
            const [pass, setPass] = useState('');
            const [confirm, setConfirm] = useState('');
            const [msg, setMsg] = useState({ type: '', text: '' });
            const [profileName, setProfileName] = useState(userData?.displayName || '');
            const [profileEmail, setProfileEmail] = useState(user.email || '');
            const [infoMsg, setInfoMsg] = useState({ type: '', text: '' });

            useEffect(() => { 
                if(userData) setProfileName(userData.displayName || '');
                if(user) setProfileEmail(user.email);
            }, [userData, user]);

            const handleUpdatePassword = async (e) => { e.preventDefault(); if (pass !== confirm) { setMsg({ type: 'error', text: 'Passwords do not match' }); return; } try { await updatePassword(user, pass); setMsg({ type: 'success', text: 'Password updated successfully!' }); setPass(''); setConfirm(''); } catch (error) { setMsg({ type: 'error', text: error.code === 'auth/requires-recent-login' ? 'Please log out and login again to update password.' : error.message }); } };
            
            const handleUpdateInfo = async (e) => {
                e.preventDefault();
                setInfoMsg({type:'', text:''});
                try {
                    // Update Name
                    if(profileName !== userData.displayName) {
                        await updateProfile(user, { displayName: profileName });
                        await updateDoc(doc(db, 'users', user.uid), { displayName: profileName });
                        setInfoMsg({type:'success', text:'Profile updated successfully!'});
                    } else {
                        setInfoMsg({type:'info', text:'No changes to save.'});
                    }
                } catch(error) {
                    setInfoMsg({type:'error', text: error.message});
                }
            };

            return (
                <div className="space-y-6">
                    <Card className="p-6">
                        <h3 className="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2"><User size={20} className="text-indigo-600" /> Account Details</h3>
                        <form onSubmit={handleUpdateInfo} className="space-y-4 max-w-md">
                            {infoMsg.text && <div className={`p-3 text-sm rounded-lg ${infoMsg.type === 'success' ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'}`}>{infoMsg.text}</div>}
                            <div><label className="block text-sm font-medium text-gray-500">Full Name</label><input className="w-full p-2 border rounded" value={profileName} onChange={e=>setProfileName(e.target.value)} /></div>
                            <div>
                                <label className="block text-sm font-medium text-gray-500">Email Address</label>
                                <input 
                                    className="w-full p-2 border rounded bg-gray-100 cursor-not-allowed text-gray-600" 
                                    value={profileEmail} 
                                    readOnly 
                                    disabled
                                    title="Contact support to change email"
                                />
                                <p className="text-xs text-gray-400 mt-1">Email cannot be changed.</p>
                            </div>
                            <div><label className="block text-sm font-medium text-gray-500">Account Type</label><Badge color="blue">{userData?.role || 'User'}</Badge></div>
                            <Button type="submit">Update Info</Button>
                        </form>
                    </Card>
                    <Card className="p-6"><h3 className="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2"><Lock size={20} className="text-indigo-600" /> Security</h3><form onSubmit={handleUpdatePassword} className="space-y-4 max-w-md">{msg.text && <div className={`p-3 text-sm rounded-lg ${msg.type === 'success' ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'}`}>{msg.text}</div>}<div><label className="block text-sm font-medium text-gray-700 mb-1">New Password</label><input type="password" className="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" value={pass} onChange={(e) => setPass(e.target.value)} placeholder="Enter new password" /></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label><input type="password" className="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" value={confirm} onChange={(e) => setConfirm(e.target.value)} placeholder="Confirm new password" /></div><Button type="submit">Update Password</Button></form></Card>
                </div>
            );
        }

        // --- USER DASHBOARD ---
        function UserDashboard({ user, userData }) {
            const [activeChatId, setActiveChatId] = useState(null);
            const [paymentModalData, setPaymentModalData] = useState(null);
            const [feedbackModalId, setFeedbackModalId] = useState(null); // State for feedback modal
            const [orgs, setOrgs] = useState([]);
            const [myRequests, setMyRequests] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [tab, setTab] = useState('find_support');
            const [confirmingCancelId, setConfirmingCancelId] = useState(null);

            useEffect(() => { const unsubOrgs = onSnapshot(query(collection(db, 'users'), where('role', '==', 'organization'), where('isActive', '==', true)), s => setOrgs(s.docs.map(d => ({ id: d.id, ...d.data() })))); const unsubReq = onSnapshot(query(collection(db, 'requests'), where('userId', '==', user.uid)), s => setMyRequests(s.docs.map(d => ({ id: d.id, ...d.data() })))); return () => { unsubOrgs(); unsubReq(); }; }, [user.uid]);
            const initiateRequest = (org, serviceObj) => { setPaymentModalData({ org, serviceName: typeof serviceObj === 'string' ? serviceObj : serviceObj.name, servicePrice: typeof serviceObj === 'object' && serviceObj.price ? serviceObj.price : null }); };
            
            const confirmPayment = async () => { if (!paymentModalData) return; try { await addDoc(collection(db, 'requests'), { userId: user.uid, userEmail: user.email, userName: userData.displayName || 'User', orgId: paymentModalData.org.id, orgName: paymentModalData.org.displayName, serviceName: paymentModalData.serviceName, servicePrice: paymentModalData.servicePrice, status: 'payment_review', createdAt: serverTimestamp() }); setPaymentModalData(null); } catch (e) { } };
            
            const cancelRequest = async (id) => {
                if (confirmingCancelId === id) {
                    try {
                        await updateDoc(doc(db, 'requests', id), { status: 'cancelled' });
                        setConfirmingCancelId(null);
                    } catch(e) { console.error("Error cancelling:", e); }
                } else {
                    setConfirmingCancelId(id);
                    setTimeout(() => setConfirmingCancelId(null), 3000);
                }
            };

            const submitFeedback = async ({ rating, comment }) => {
                if (!feedbackModalId) return;
                try {
                    await updateDoc(doc(db, 'requests', feedbackModalId), {
                        feedback: {
                            rating,
                            comment,
                            createdAt: serverTimestamp()
                        }
                    });
                    setFeedbackModalId(null);
                } catch (e) {
                    console.error("Error submitting feedback:", e);
                    alert("Failed to submit feedback. Please try again.");
                }
            };

            const startChat = async (org) => { 
                const q = query(collection(db, 'chats'), where('participants', 'array-contains', user.uid)); 
                const snapshot = await getDocs(q); 
                const existingChat = snapshot.docs.find(doc => doc.data().participants.includes(org.id)); 
                if (existingChat) { setActiveChatId(existingChat.id); } 
                else { 
                    const newChatRef = await addDoc(collection(db, 'chats'), { 
                        participants: [user.uid, org.id], 
                        participantData: { [user.uid]: { name: user.displayName || 'User', email: user.email }, [org.id]: { name: org.displayName, email: org.email } }, 
                        createdAt: serverTimestamp(), lastMessage: '', lastMessageTime: serverTimestamp() 
                    }); 
                    setActiveChatId(newChatRef.id); 
                } 
            };
            const filteredOrgs = orgs.filter(o => o.displayName?.toLowerCase().includes(searchTerm.toLowerCase()) || o.services?.some(s => (typeof s === 'string' ? s : s.name).toLowerCase().includes(searchTerm.toLowerCase())));

            return (
                <div className="grid lg:grid-cols-4 gap-8">
                    <div className="lg:col-span-1 space-y-4"><Card className="p-4"><h3 className="font-bold text-gray-900 mb-4 px-2">Menu</h3><div className="space-y-1"><button onClick={()=>setTab('find_support')} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${tab==='find_support'?'bg-indigo-50 text-indigo-700':'text-gray-600 hover:bg-gray-50'}`}><Search size={18} /> Find Support</button><button onClick={()=>setTab('requests')} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${tab==='requests'?'bg-indigo-50 text-indigo-700':'text-gray-600 hover:bg-gray-50'}`}><CheckCircle size={18} /> My Requests</button><button onClick={()=>setTab('profile')} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${tab==='profile'?'bg-indigo-50 text-indigo-700':'text-gray-600 hover:bg-gray-50'}`}><Settings size={18} /> Profile</button><button onClick={()=>setTab('grievances')} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${tab==='grievances'?'bg-indigo-50 text-indigo-700':'text-gray-600 hover:bg-gray-50'}`}><AlertTriangle size={18} /> Grievances</button></div></Card></div>
                    <div className="lg:col-span-3">
                        {tab === 'find_support' && (<div className="space-y-6"><div className="flex flex-col md:flex-row justify-between items-center gap-4"><h2 className="text-2xl font-bold text-gray-900">Find Support</h2><input className="w-full md:w-64 px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Search..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} /></div><div className="grid gap-6">{filteredOrgs.map(org => (<Card key={org.id} className="p-6"><div className="flex items-start justify-between"><div><h3 className="text-xl font-bold text-gray-900">{org.displayName}</h3><p className="text-gray-500 text-sm mt-1">{org.description || "No description."}</p></div><div className="flex flex-col gap-2"><div className="p-2 bg-indigo-50 rounded-lg text-indigo-600 self-end"><Building2 size={24} /></div><Button variant="secondary" onClick={() => startChat(org)} className="!py-1 !px-2 !text-xs gap-1"><MessageCircle size={14}/> Message</Button></div></div><div className="mt-6"><h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Services</h4><div className="flex flex-wrap gap-2">{org.services?.map((s, i) => <button key={i} onClick={()=>initiateRequest(org, s)} className="px-3 py-2 bg-gray-100 hover:bg-indigo-600 hover:text-white text-gray-700 rounded-lg text-sm font-medium transition-colors text-left flex flex-col items-start gap-1"><span className="font-bold">{typeof s === 'string' ? s : s.name} {s.price && `(${s.price})`}</span>{s.description && <span className="text-xs opacity-75 font-normal">{s.description}</span>}</button>)}</div></div></Card>))}</div></div>)}
                        {tab === 'requests' && (<Card className="p-6"><h3 className="font-bold text-gray-900 mb-4">My Requests</h3><div className="space-y-3">{myRequests.map(r => (
                            <div key={r.id} className="p-4 bg-gray-50 rounded border text-sm flex flex-col gap-3">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="font-bold text-indigo-900">{r.serviceName} {r.servicePrice && `(${r.servicePrice})`}</span>
                                            <Badge color={r.status==='accepted'?'green':r.status==='declined'?'red':r.status==='in_progress'?'yellow':r.status==='completed'?'green':r.status==='cancelled'?'gray':'blue'}>{r.status === 'payment_review' ? 'Payment Review' : r.status}</Badge>
                                        </div>
                                        <div className="text-gray-600 text-xs">{r.orgName}</div>
                                    </div>
                                    {['pending', 'payment_review'].includes(r.status) && (
                                        <button 
                                            onClick={() => cancelRequest(r.id)} 
                                            className={`text-xs underline ${confirmingCancelId === r.id ? 'text-red-700 font-bold' : 'text-red-500 hover:text-red-700'}`}
                                        >
                                            {confirmingCancelId === r.id ? "Confirm Cancel?" : "Cancel Request"}
                                        </button>
                                    )}
                                </div>
                                
                                {/* Feedback Section */}
                                {r.status === 'completed' && (
                                    <div className="border-t border-gray-200 pt-3 mt-1">
                                        {r.feedback ? (
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xs font-bold text-gray-500">Your Feedback:</span>
                                                    <StarRating rating={r.feedback.rating} />
                                                </div>
                                                <span className="text-xs text-green-600 flex items-center gap-1"><CheckCircle size={12}/> Submitted</span>
                                            </div>
                                        ) : (
                                            <Button variant="secondary" onClick={() => setFeedbackModalId(r.id)} className="w-full !py-1.5 !text-sm border-indigo-200 text-indigo-700 hover:bg-indigo-50">
                                                <Star size={14} /> Rate Service
                                            </Button>
                                        )}
                                    </div>
                                )}
                            </div>
                        ))}</div></Card>)}
                        {tab === 'profile' && <UserProfile user={user} userData={userData} />}
                        {tab === 'grievances' && <CommonGrievanceList user={user} role="user" />}
                    </div>
                    {activeChatId && <ChatWindow chatId={activeChatId} onClose={() => setActiveChatId(null)} currentUser={user} />}
                    {paymentModalData && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full"><h3 className="text-lg font-bold text-gray-900 mb-2">Confirm Payment</h3><p className="text-gray-600 text-sm mb-4">Proceed with request for <span className="font-bold text-indigo-600">{paymentModalData.serviceName}</span>?</p><div className="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-6 text-center"><div className="text-xs text-gray-500 mb-1">UPI ID</div><div className="font-mono font-bold text-lg text-gray-800 select-all">{UPI_ID}</div>{paymentModalData.servicePrice && (<div className="mt-2 text-indigo-600 font-bold">Amount: {paymentModalData.servicePrice}</div>)}</div><div className="flex gap-3"><Button onClick={() => setPaymentModalData(null)} variant="secondary" className="flex-1">Cancel</Button><Button onClick={confirmPayment} variant="primary" className="flex-1">Payment Done</Button></div></div></div>)}
                    {feedbackModalId && <FeedbackModal onClose={() => setFeedbackModalId(null)} onSubmit={submitFeedback} />}
                </div>
            );
        }

        // --- MAIN APP COMPONENT (MOVED TO END) ---
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [userRole, setUserRole] = useState(null); 
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('home'); 
            const [isDeactivated, setIsDeactivated] = useState(false);
            const [isUnverified, setIsUnverified] = useState(false); 
            const [showGlobalTerms, setShowGlobalTerms] = useState(false); 

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    setIsDeactivated(false);
                    setIsUnverified(false);

                    if (user) {
                        setCurrentUser(user);
                        try {
                            if (SUPER_ADMINS.includes(user.email)) {
                                await setDoc(doc(db, 'users', user.uid), {
                                    email: user.email, role: 'admin', isActive: true, displayName: 'Super Admin', uid: user.uid
                                }, { merge: true });
                            }
                            const userDocSnap = await getDoc(doc(db, 'users', user.uid));
                            if (userDocSnap.exists()) {
                                const data = userDocSnap.data();
                                
                                if (!data.isActive) {
                                    setIsDeactivated(true);
                                    await signOut(auth);
                                    setCurrentUser(null);
                                    setUserRole(null);
                                    setView('home');
                                    setLoading(false);
                                    return;
                                } 
                                
                                if (data.role === 'user' && !user.emailVerified) {
                                    setIsUnverified(true);
                                    setUserData(data);
                                    setUserRole(data.role);
                                } else {
                                    setUserData(data);
                                    setUserRole(data.role);
                                }
                            } else {
                                setUserRole('user'); 
                                if (!user.emailVerified) setIsUnverified(true);
                            }
                        } catch (error) {
                            console.error("Error fetching user data:", error);
                            setUserRole('user');
                        }
                    } else {
                        setCurrentUser(null);
                        setUserData(null);
                        setUserRole(null);
                        setView('home');
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!currentUser) return;
                
                const updatePresence = async () => {
                    try {
                        await updateDoc(doc(db, 'users', currentUser.uid), {
                            lastSeen: serverTimestamp()
                        });
                    } catch (err) {
                        console.error("Error updating presence:", err);
                    }
                };
                updatePresence();
                const intervalId = setInterval(updatePresence, 60 * 1000);
                return () => clearInterval(intervalId);
            }, [currentUser]);

            const handleSignOut = async () => { await signOut(auth); setView('home'); setUserRole(null); };

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-gray-50"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>;

            if (isDeactivated) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-md text-center">
                            <XCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
                            <h2 className="text-2xl font-bold text-gray-900 mb-2">Account Deactivated</h2>
                            <p className="text-gray-600 mb-6">Your account has been deactivated by an administrator. Please contact support for assistance.</p>
                            <Button onClick={() => setIsDeactivated(false)}>Back to Home</Button>
                        </div>
                    </div>
                );
            }

            if (isUnverified) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                         <div className="bg-white p-8 rounded-xl shadow-lg max-w-md text-center">
                            <Mail className="w-16 h-16 text-indigo-500 mx-auto mb-4" />
                            <h2 className="text-2xl font-bold text-gray-900 mb-2">Verify Your Email</h2>
                            <p className="text-gray-600 mb-6">
                                Thanks for joining Shades of Hue! We've sent a verification link to <strong>{currentUser?.email}</strong>. 
                                Please verify your email to access your dashboard.
                            </p>
                            <div className="space-y-3">
                                <Button className="w-full" onClick={() => window.location.reload()}>I've Verified My Email</Button>
                                <Button variant="secondary" className="w-full" onClick={async () => {
                                    try {
                                        await sendEmailVerification(currentUser);
                                        alert("Verification email resent!");
                                    } catch(e) { alert("Error: " + e.message); }
                                }}>Resend Verification Email</Button>
                                <button onClick={handleSignOut} className="text-gray-400 hover:text-gray-600 text-sm underline">Sign Out</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans flex flex-col">
                    <Navbar user={currentUser} role={userRole} onNavigate={setView} onSignOut={handleSignOut} currentView={view} />
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow w-full">
                        {view === 'home' && <Home user={currentUser} onNavigate={setView} />}
                        {view === 'login' && <Login onNavigate={setView} />}
                        {view === 'signup' && <Signup onNavigate={setView} />}
                        {view === 'dashboard' && userRole === 'admin' && <AdminDashboard user={currentUser} />}
                        {view === 'dashboard' && userRole === 'organization' && <OrgDashboard user={currentUser} userData={userData} />}
                        {view === 'dashboard' && userRole === 'user' && <UserDashboard user={currentUser} userData={userData} />}
                    </main>
                    
                    <Footer onShowTerms={() => setShowGlobalTerms(true)} />
                    
                    {showGlobalTerms && <TermsModal onClose={() => setShowGlobalTerms(false)} />}
                </div>
            );
        }

        // --- RENDER APP ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>