<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-6603110789295505">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6603110789295505"
     crossorigin="anonymous"></script>
    <title>Shades of Hue</title>
    
    <!-- 1. Load Styles (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                            950: '#0d1117',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- 2. Configure Modules (Import Map) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <!-- 3. Load Babel (To understand JSX code in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar for Chat */
        .overflow-y-auto::-webkit-scrollbar { width: 6px; }
        .overflow-y-auto::-webkit-scrollbar-track { background: transparent; }
        .overflow-y-auto::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .overflow-y-auto::-webkit-scrollbar-thumb { background-color: #4b5563; }
        
        body {
            transition: background-color 0.3s, color 0.3s;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans transition-colors duration-200">
    <div id="root"></div>

    <!-- 4. Your Application Code -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut,
            updatePassword,
            updateEmail,
            updateProfile,
            sendEmailVerification
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs, 
            getDoc,
            doc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            addDoc, 
            onSnapshot,
            serverTimestamp,
            orderBy,
            limit
        } from 'firebase/firestore';
        // ADDED deleteApp here
        import { initializeApp, deleteApp } from 'firebase/app';
        import { 
            User, Shield, Building2, LogOut, Plus, Trash2, CheckCircle, XCircle, 
            Newspaper, MessageSquare, Menu, X, Heart, Briefcase, Send, 
            MessageCircle, IndianRupee, Check, Settings, Lock, Search, AlertCircle, Clock, Edit2, AlertTriangle, FileText,
            BookOpen, Users, Activity, Gift, Sun, Moon, Mail, ShoppingBag, Tag
        } from 'lucide-react';

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC907raHdPtNtNxBNLxImf7i-FfPIvglhE",
            authDomain: "sohh-7b016.firebaseapp.com",
            projectId: "sohh-7b016",
            storageBucket: "sohh-7b016.firebasestorage.app",
            messagingSenderId: "436729414470",
            appId: "1:436729414470:web:da0db38fedb21aaeac5b47",
            measurementId: "G-SDNWQPHX47"
        };

        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONSTANTS ---
        const SUPER_ADMINS = ['rajsimariaa@gmail.com', 'krutika3011@gmail.com'];
        const UPI_ID = "rajsimariaa-2@okaxis";

        // --- UI COMPONENTS ---
        const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500 shadow-md shadow-indigo-200 dark:shadow-none",
                secondary: "bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-gray-400",
                danger: "bg-rose-600 text-white hover:bg-rose-700 focus:ring-rose-500 shadow-md shadow-rose-200 dark:shadow-none",
                ghost: "text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white",
                success: "bg-emerald-600 text-white hover:bg-emerald-700 focus:ring-emerald-500"
            };
            return (
                <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Card = ({ children, className = '' }) => (
            <div className={`bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden transition-colors duration-200 ${className}`}>
                {children}
            </div>
        );

        const Badge = ({ children, color = 'blue' }) => {
            const colors = {
                blue: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300', 
                green: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300', 
                red: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300',
                purple: 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300', 
                gray: 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300', 
                indigo: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-300',
                orange: 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300',
                yellow: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300'
            };
            return <span className={`px-2.5 py-0.5 rounded-full text-xs font-semibold ${colors[color] || colors.gray}`}>{children}</span>;
        };

        // --- VERIFY EMAIL COMPONENT ---
        function VerifyEmailPage({ user, onSignOut }) {
            const [sent, setSent] = useState(false);
            const [error, setError] = useState('');
            const [checking, setChecking] = useState(false);

            const resendEmail = async () => {
                try {
                    await sendEmailVerification(user);
                    setSent(true);
                    setError('');
                } catch (e) {
                    setError('Too many requests. Please wait before retrying.');
                }
            };

            const checkVerification = async () => {
                setChecking(true);
                try {
                    await user.reload();
                    if (user.emailVerified) {
                        window.location.reload(); 
                    } else {
                        setError('Email not yet verified. Please check your inbox.');
                    }
                } catch(e) {
                    console.error(e);
                }
                setChecking(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 p-4">
                    <Card className="max-w-md w-full p-8 text-center">
                        <div className="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Mail size={32} />
                        </div>
                        <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-2">Verify your email</h2>
                        <p className="text-gray-600 dark:text-gray-300 mb-6">
                            We've sent a verification link to <strong>{user.email}</strong>.<br/>
                            Please verify your email to access the platform.
                        </p>
                        
                        {sent && <div className="mb-4 p-3 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg text-sm">Verification email sent!</div>}
                        {error && <div className="mb-4 p-3 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-lg text-sm">{error}</div>}

                        <div className="space-y-3">
                            <Button onClick={checkVerification} className="w-full justify-center" disabled={checking}>
                                {checking ? 'Checking...' : "I've Verified My Email"}
                            </Button>
                            <Button variant="secondary" onClick={resendEmail} className="w-full justify-center" disabled={sent}>
                                Resend Email
                            </Button>
                            <button onClick={onSignOut} className="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 underline mt-4">
                                Sign Out
                            </button>
                        </div>
                    </Card>
                </div>
            );
        }

        // --- TERMS MODAL ---
        function TermsModal({ onClose }) {
            return (
                <div className="fixed inset-0 bg-black/50 dark:bg-black/70 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-3xl w-full max-h-[85vh] flex flex-col border dark:border-gray-700">
                        <div className="p-5 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50 rounded-t-xl">
                            <h3 className="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                <FileText size={20} className="text-indigo-600 dark:text-indigo-400" /> Platform Policies & Guidelines
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 rounded p-1 transition-colors"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto text-sm text-gray-700 dark:text-gray-300 space-y-6 leading-relaxed">
                            <div>
                                <h4 className="font-bold text-lg text-gray-900 dark:text-white mb-2">Shades of Hue: Official Platform Policies and Guidelines</h4>
                                <p>These policies govern the conduct of all users, customers, and partnered organizations within the Shades of Hue platform.</p>
                            </div>
                            <div>
                                <h4 className="font-bold text-base text-gray-800 dark:text-gray-200 mb-2">I. Core Principles and Code of Conduct</h4>
                                <p>These principles are the foundation of our community and mandate the highest standards of professional and ethical behavior.</p>
                                <ul className="list-disc pl-5 mt-2 space-y-1">
                                    <li><strong>Mission Alignment:</strong> All panel organizations must actively align with the mission of supporting and empowering the queer community.</li>
                                    <li><strong>Respect and Professionalism:</strong> We enforce a Zero-Tolerance Policy for rude, aggressive, discriminatory, or harassing behavior.</li>
                                </ul>
                            </div>
                        </div>
                        <div className="p-5 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 rounded-b-xl flex justify-end">
                            <Button onClick={onClose}>Close</Button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- ORDER MODAL (NEW) ---
        function OrderModal({ product, onClose, onConfirm }) {
            const [address, setAddress] = useState('');
            const [sellerUpi, setSellerUpi] = useState('Loading...');

            useEffect(() => {
                const fetchSeller = async () => {
                    try {
                        const snap = await getDoc(doc(db, 'users', product.sellerId));
                        if(snap.exists()) setSellerUpi(snap.data().upiId || 'Not provided');
                        else setSellerUpi('Not found');
                    } catch(e) { setSellerUpi('Error fetching'); }
                };
                fetchSeller();
            }, [product.sellerId]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if(!address.trim()) return alert("Please enter delivery address");
                onConfirm(address, sellerUpi);
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-sm w-full shadow-2xl">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold dark:text-white">Complete Order</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><X size={20}/></button>
                        </div>
                        <div className="mb-4 space-y-2 text-sm text-gray-600 dark:text-gray-300">
                            <p><span className="font-bold">Item:</span> {product.name}</p>
                            <p><span className="font-bold">Price:</span> ₹{product.price}</p>
                            <div className="p-3 bg-indigo-50 dark:bg-indigo-900/30 rounded border border-indigo-100 dark:border-indigo-800">
                                <p className="text-xs uppercase font-bold text-indigo-800 dark:text-indigo-300 mb-1">Seller UPI ID</p>
                                <p className="font-mono font-bold text-lg text-indigo-600 dark:text-indigo-400 select-all">{sellerUpi}</p>
                                <p className="text-[10px] mt-1 text-gray-500 dark:text-gray-400">Scan or copy to pay via UPI app.</p>
                            </div>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <label className="block text-sm font-medium mb-1 dark:text-gray-300">Delivery Address</label>
                            <textarea 
                                className="w-full p-2 border rounded mb-4 dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" 
                                rows={3} 
                                placeholder="Street, City, Pincode..." 
                                value={address} 
                                onChange={e=>setAddress(e.target.value)} 
                                required 
                            />
                            <div className="flex gap-2">
                                <Button type="submit" className="flex-1">Confirm & Order</Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // --- DONATION MODAL ---
        function DonationModal({ onClose }) {
            const [name, setName] = useState('');
            const [amount, setAmount] = useState('');
            const [step, setStep] = useState(1); 

            const handleNext = (e) => {
                e.preventDefault();
                if(name && amount) setStep(2);
            }

            const handleDone = async () => {
                try {
                    await addDoc(collection(db, 'donations'), {
                        name,
                        amount,
                        createdAt: serverTimestamp(),
                        status: 'user_confirmed'
                    });
                    alert("Thank you for your donation!");
                    onClose();
                } catch(e) {
                    console.error(e);
                    alert("Error recording donation.");
                }
            }

            return (
                <div className="fixed inset-0 bg-black/50 dark:bg-black/70 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-sm w-full border dark:border-gray-700">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                <Heart className="text-rose-600 fill-rose-600" size={24}/> Make a Donation
                            </h3>
                            <button onClick={onClose} className="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"><X size={20} /></button>
                        </div>
                        
                        {step === 1 ? (
                            <form onSubmit={handleNext} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Your Name</label>
                                    <input className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-rose-500 outline-none" value={name} onChange={e=>setName(e.target.value)} required placeholder="Enter your name" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Amount (₹)</label>
                                    <input type="number" className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-rose-500 outline-none" value={amount} onChange={e=>setAmount(e.target.value)} required placeholder="Enter amount" />
                                </div>
                                <Button type="submit" className="w-full bg-rose-600 hover:bg-rose-700 focus:ring-rose-500 shadow-rose-200 dark:shadow-none text-white">Proceed to Pay</Button>
                            </form>
                        ) : (
                            <div className="space-y-4">
                                <div className="bg-indigo-50 dark:bg-indigo-900/30 p-4 rounded-lg text-center border border-indigo-100 dark:border-indigo-800">
                                    <p className="text-sm text-gray-600 dark:text-gray-300 mb-2">Scan QR or use UPI ID</p>
                                    <div className="font-mono font-bold text-xl text-indigo-700 dark:text-indigo-400 select-all p-2 bg-white dark:bg-gray-800 rounded border border-indigo-200 dark:border-indigo-700">{UPI_ID}</div>
                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">Paying: <span className="font-bold text-gray-900 dark:text-white">₹{amount}</span></p>
                                </div>
                                <p className="text-xs text-center text-gray-500 dark:text-gray-400">Click below once you have completed the transaction in your UPI app.</p>
                                <Button onClick={handleDone} variant="success" className="w-full">Payment Done</Button>
                                <Button onClick={()=>setStep(1)} variant="ghost" className="w-full text-xs">Back</Button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- NAVBAR COMPONENT ---
        function Navbar({ user, role, onNavigate, onSignOut, currentView, theme, toggleTheme }) {
            const [isOpen, setIsOpen] = useState(false);
            const NavLink = ({ target, label, icon: Icon }) => (
                <button onClick={() => { onNavigate(target); setIsOpen(false); }} className={`flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium transition-colors ${currentView === target ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white'}`}>
                    {Icon && <Icon size={16} />} {label}
                </button>
            );
            const roleLabel = role ? role.charAt(0).toUpperCase() + role.slice(1) : 'User';

            return (
                <nav className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 transition-colors duration-200">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex justify-between h-16">
                            <div className="flex items-center">
                                <button onClick={() => onNavigate('home')} className="flex-shrink-0 flex items-center gap-2 cursor-pointer">
                                    <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl">S</div>
                                    <span className="font-bold text-xl bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">Shades of Hue</span>
                                </button>
                            </div>
                            <div className="hidden md:flex items-center space-x-4">
                                <NavLink target="home" label="Home" icon={Newspaper} />
                                <NavLink target="store" label="Store" icon={ShoppingBag} />
                                {!user ? (
                                    <>
                                        <Button variant="ghost" onClick={() => onNavigate('login')}>Sign In</Button>
                                        <Button variant="primary" onClick={() => onNavigate('signup')}>Join Us</Button>
                                    </>
                                ) : (
                                    <>
                                        {role && <NavLink target="dashboard" label={`${roleLabel} Dashboard`} icon={Briefcase} />}
                                        <div className="border-l border-gray-300 dark:border-gray-600 h-6 mx-2"></div>
                                        <div className="flex items-center gap-3">
                                            <div className="text-right hidden lg:block">
                                                <p className="text-sm font-medium text-gray-900 dark:text-white">{user.email}</p>
                                                <p className="text-xs text-gray-500 dark:text-gray-400 capitalize">{role || '...'}</p>
                                            </div>
                                            <Button variant="secondary" onClick={onSignOut} className="!px-3"><LogOut size={16} /></Button>
                                        </div>
                                    </>
                                )}
                                <button onClick={toggleTheme} className="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                    {theme === 'dark' ? <Sun size={20} /> : <Moon size={20} />}
                                </button>
                            </div>
                            <div className="flex items-center md:hidden gap-2">
                                <button onClick={toggleTheme} className="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                                    {theme === 'dark' ? <Sun size={20} /> : <Moon size={20} />}
                                </button>
                                <button onClick={() => setIsOpen(!isOpen)} className="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white p-2">
                                    {isOpen ? <X size={24} /> : <Menu size={24} />}
                                </button>
                            </div>
                        </div>
                    </div>
                    {isOpen && (
                        <div className="md:hidden bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-2 pt-2 pb-3 space-y-1">
                            <NavLink target="home" label="Home" icon={Newspaper} />
                            <NavLink target="store" label="Store" icon={ShoppingBag} />
                            {user && role && <NavLink target="dashboard" label="Dashboard" icon={Briefcase} />}
                            {!user ? (
                                <div className="flex flex-col gap-2 p-2 mt-2 border-t border-gray-100 dark:border-gray-700">
                                    <Button variant="secondary" onClick={() => { onNavigate('login'); setIsOpen(false); }}>Sign In</Button>
                                    <Button variant="primary" onClick={() => { onNavigate('signup'); setIsOpen(false); }}>Join Us</Button>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-2 p-2 mt-2 border-t border-gray-100 dark:border-gray-700"><Button variant="danger" onClick={() => { onSignOut(); setIsOpen(false); }}>Sign Out</Button></div>
                            )}
                        </div>
                    )}
                </nav>
            );
        }

        // --- MAIN APP COMPONENT ---
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [userRole, setUserRole] = useState(null); 
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('home'); 
            const [verificationRequired, setVerificationRequired] = useState(false);
            
            // Theme Management
            const [theme, setTheme] = useState(() => {
                if (typeof window !== 'undefined') {
                    return localStorage.getItem('theme') || 'light';
                }
                return 'light';
            });

            useEffect(() => {
                const root = window.document.documentElement;
                if (theme === 'dark') {
                    root.classList.add('dark');
                } else {
                    root.classList.remove('dark');
                }
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prev => prev === 'light' ? 'dark' : 'light');
            };

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        setCurrentUser(user);
                        try {
                            if (SUPER_ADMINS.includes(user.email)) {
                                await setDoc(doc(db, 'users', user.uid), {
                                    email: user.email, role: 'admin', isActive: true, displayName: 'Super Admin', uid: user.uid
                                }, { merge: true });
                            }
                            const userDocSnap = await getDoc(doc(db, 'users', user.uid));
                            if (userDocSnap.exists()) {
                                const data = userDocSnap.data();
                                // Admin Deactivation Check
                                if (!data.isActive) {
                                    alert("Your account has been deactivated by an admin. Please contact support.");
                                    await signOut(auth);
                                    setCurrentUser(null);
                                    setUserRole(null);
                                    setView('home');
                                    setVerificationRequired(false);
                                } else {
                                    setUserData(data);
                                    setUserRole(data.role);
                                    // CHECK VERIFICATION FOR REGULAR USERS ONLY
                                    // Admins, Orgs, AND SELLERS are exempt from email verification check for login
                                    if (data.role === 'user' && !user.emailVerified) {
                                        setVerificationRequired(true);
                                    } else {
                                        setVerificationRequired(false);
                                    }
                                }
                            } else {
                                setUserRole('user'); 
                                // Default new user check
                                if (!user.emailVerified) setVerificationRequired(true);
                            }
                        } catch (error) {
                            console.error("Error fetching user data:", error);
                            setUserRole('user');
                        }
                    } else {
                        setCurrentUser(null);
                        setUserData(null);
                        setUserRole(null);
                        setView('home');
                        setVerificationRequired(false);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // --- PRESENCE SYSTEM (HEARTBEAT) ---
            useEffect(() => {
                if (!currentUser) return;
                
                const updatePresence = async () => {
                    try {
                        await updateDoc(doc(db, 'users', currentUser.uid), {
                            lastSeen: serverTimestamp()
                        });
                    } catch (err) {
                        console.error("Error updating presence:", err);
                    }
                };

                updatePresence();
                const intervalId = setInterval(updatePresence, 60 * 1000);
                return () => clearInterval(intervalId);
            }, [currentUser]);

            const handleSignOut = async () => { await signOut(auth); setView('home'); setUserRole(null); setVerificationRequired(false); };

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 dark:border-indigo-400"></div>
                </div>
            );

            // BLOCK ACCESS IF VERIFICATION IS REQUIRED
            if (verificationRequired) {
                return <VerifyEmailPage user={currentUser} onSignOut={handleSignOut} />;
            }

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans transition-colors duration-200">
                    <Navbar user={currentUser} role={userRole} onNavigate={setView} onSignOut={handleSignOut} currentView={view} theme={theme} toggleTheme={toggleTheme} />
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {view === 'home' && <Home user={currentUser} onNavigate={setView} />}
                        {view === 'store' && <Store user={currentUser} />}
                        {view === 'login' && <Login onNavigate={setView} />}
                        {view === 'signup' && <Signup onNavigate={setView} />}
                        {view === 'dashboard' && userRole === 'admin' && <AdminDashboard user={currentUser} />}
                        {view === 'dashboard' && userRole === 'organization' && <OrgDashboard user={currentUser} userData={userData} />}
                        {view === 'dashboard' && userRole === 'user' && <UserDashboard user={currentUser} userData={userData} />}
                        {view === 'dashboard' && userRole === 'seller' && <SellerDashboard user={currentUser} userData={userData} />}
                    </main>
                </div>
            );
        }

        // --- DASHBOARDS & PAGES ---
        function Home({ user, onNavigate }) {
            const [news, setNews] = useState([]);
            const [showDonate, setShowDonate] = useState(false);

            useEffect(() => {
                const unsubscribe = onSnapshot(query(collection(db, 'news'), orderBy('createdAt', 'desc')), 
                    (snapshot) => setNews(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))), 
                    (error) => console.error("News error:", error)
                );
                return () => unsubscribe();
            }, []);

            return (
                <div className="space-y-12 relative">
                    {showDonate && <DonationModal onClose={() => setShowDonate(false)} />}
                    <section className="text-center space-y-6 py-12">
                        <h1 className="text-4xl md:text-6xl font-extrabold text-gray-900 dark:text-white tracking-tight">Empowering the <span className="text-indigo-600 dark:text-indigo-400">Queer Community</span></h1>
                        <p className="max-w-2xl mx-auto text-lg md:text-xl text-gray-600 dark:text-gray-300">Connecting you with inclusive services, supportive organizations, and a community that cares.</p>
                        <div className="flex justify-center gap-4 flex-wrap">
                            {!user && (
                                <>
                                    <Button onClick={() => onNavigate('signup')} className="!text-lg !px-8 !py-3">Get Started</Button>
                                    <Button variant="secondary" onClick={() => onNavigate('login')} className="!text-lg !px-8 !py-3">Sign In</Button>
                                </>
                            )}
                            <button 
                                onClick={() => setShowDonate(true)}
                                className="flex items-center gap-2 px-8 py-3 rounded-lg font-medium text-lg bg-rose-600 text-white hover:bg-rose-700 shadow-md shadow-rose-200 dark:shadow-none transition-all"
                            >
                                <Heart className="fill-white" size={20} /> Donate
                            </button>
                        </div>
                    </section>
                    
                    <div className="grid md:grid-cols-2 gap-8">
                        <Card className="p-8 bg-gradient-to-br from-indigo-50 to-white dark:from-gray-800 dark:to-gray-750 border-indigo-100 dark:border-gray-700">
                            <div className="flex items-center gap-3 mb-4"><div className="p-2 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg text-indigo-600 dark:text-indigo-300"><Heart size={24} /></div><h2 className="text-2xl font-bold text-gray-900 dark:text-white">Our Mission</h2></div>
                            <p className="text-gray-600 dark:text-gray-300 leading-relaxed">To provide a safe, accessible, and affirmative platform for Queer individuals to access essential services.</p>
                        </Card>
                        <Card className="p-8 bg-gradient-to-br from-purple-50 to-white dark:from-gray-800 dark:to-gray-750 border-purple-100 dark:border-gray-700">
                            <div className="flex items-center gap-3 mb-4"><div className="p-2 bg-purple-100 dark:bg-purple-900/50 rounded-lg text-purple-600 dark:text-purple-300"><Shield size={24} /></div><h2 className="text-2xl font-bold text-gray-900 dark:text-white">Our Vision</h2></div>
                            <p className="text-gray-600 dark:text-gray-300 leading-relaxed">A world where every Queer individual has equal access to healthcare, legal aid, housing, and community support.</p>
                        </Card>
                    </div>

                    <section className="py-8">
                        <div className="text-center mb-8">
                          <h2 className="text-3xl font-bold text-gray-900 dark:text-white">Our Services</h2>
                          <p className="text-gray-600 dark:text-gray-400 mt-2">Holistic support for the community.</p>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                          {[
                            { icon: BookOpen, title: "Skill Development", desc: "Training programs to enhance your professional skillset." },
                            { icon: Briefcase, title: "Employment", desc: "Connecting you with inclusive employers and job opportunities." },
                            { icon: Users, title: "Inclusivity Workshops", desc: "Sensitization and awareness sessions for organizations." },
                            { icon: Heart, title: "Mental Health", desc: "Counseling and support groups for emotional well-being." }
                          ].map((s, i) => (
                            <Card key={i} className="p-6 text-center hover:shadow-md dark:hover:bg-gray-750 transition-all">
                              <div className="w-12 h-12 mx-auto bg-indigo-50 dark:bg-indigo-900/30 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-400 mb-4">
                                <s.icon size={24} />
                              </div>
                              <h3 className="font-bold text-lg text-gray-900 dark:text-white mb-2">{s.title}</h3>
                              <p className="text-sm text-gray-600 dark:text-gray-400">{s.desc}</p>
                            </Card>
                          ))}
                        </div>
                    </section>

                    <section>
                        <div className="flex items-center gap-3 mb-6"><Newspaper className="text-indigo-600 dark:text-indigo-400" /><h2 className="text-2xl font-bold text-gray-900 dark:text-white">Latest Updates</h2></div>
                        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                            {news.length > 0 ? news.map(item => (
                                <Card key={item.id} className="p-6 flex flex-col h-full hover:shadow-md transition-shadow">
                                    <div className="mb-4"><span className="text-xs font-medium text-gray-500 dark:text-gray-400">{item.createdAt?.toDate ? item.createdAt.toDate().toLocaleDateString() : 'Just now'}</span><h3 className="text-xl font-bold text-gray-900 dark:text-white mt-1">{item.title}</h3></div>
                                    <p className="text-gray-600 dark:text-gray-300 text-sm flex-grow whitespace-pre-wrap">{item.content}</p>
                                </Card>
                            )) : <div className="col-span-full text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-xl border border-dashed border-gray-300 dark:border-gray-700 text-gray-500 dark:text-gray-400">No news updates yet. Stay tuned!</div>}
                        </div>
                    </section>
                </div>
            );
        }

        function Store({ user }) {
            const [products, setProducts] = useState([]);
            const [selectedProduct, setSelectedProduct] = useState(null);
            
            useEffect(() => {
                const q = query(collection(db, 'products'), orderBy('createdAt', 'desc'));
                const unsub = onSnapshot(q, (s) => setProducts(s.docs.map(d => ({id:d.id, ...d.data()}))), (e) => console.log("Store load err", e));
                return () => unsub();
            }, []);

            const handleBuy = (product) => {
                if(!user) { alert("Please login to buy products."); return; }
                setSelectedProduct(product);
            };

            const confirmOrder = async (address, sellerUpi) => {
                if(!selectedProduct) return;
                try {
                    await addDoc(collection(db, 'orders'), {
                        productId: selectedProduct.id,
                        productName: selectedProduct.name,
                        price: selectedProduct.price,
                        sellerId: selectedProduct.sellerId,
                        sellerUpiId: sellerUpi, // Store snapshot of UPI ID at time of order
                        buyerId: user.uid,
                        buyerEmail: user.email,
                        address: address, // Store buyer address
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    alert("Order placed successfully!");
                    setSelectedProduct(null);
                } catch(e) {
                    console.error(e);
                    alert("Failed to place order.");
                }
            };

            return (
                <div className="space-y-8">
                    {selectedProduct && <OrderModal product={selectedProduct} onClose={()=>setSelectedProduct(null)} onConfirm={confirmOrder} />}
                    
                    <div className="text-center space-y-2">
                        <h2 className="text-3xl font-bold text-gray-900 dark:text-white">Community Store</h2>
                        <p className="text-gray-600 dark:text-gray-400">Support local creators and small businesses.</p>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        {products.map(p => (
                            <Card key={p.id} className="flex flex-col h-full hover:shadow-lg transition-shadow">
                                <div className="aspect-square bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400">
                                    {/* Placeholder for Product Image */}
                                    <ShoppingBag size={48} opacity={0.2} />
                                </div>
                                <div className="p-4 flex flex-col flex-grow">
                                    <h3 className="font-bold text-lg text-gray-900 dark:text-white mb-1">{p.name}</h3>
                                    <p className="text-sm text-gray-500 dark:text-gray-400 mb-3 flex-grow">{p.description}</p>
                                    <div className="flex justify-between items-center mt-auto">
                                        <span className="font-bold text-indigo-600 dark:text-indigo-400">₹{p.price}</span>
                                        <Button onClick={() => handleBuy(p)} className="!py-1 !px-3 !text-sm">Buy Now</Button>
                                    </div>
                                </div>
                            </Card>
                        ))}
                    </div>
                    {products.length === 0 && <p className="text-center text-gray-500 dark:text-gray-400 py-12">No products available yet.</p>}
                </div>
            );
        }

        function SellerDashboard({ user, userData }) {
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [newProd, setNewProd] = useState({ name: '', price: '', description: '' });
            const [upiId, setUpiId] = useState(userData?.upiId || '');

            useEffect(() => {
                if (userData?.upiId) setUpiId(userData.upiId);
            }, [userData]);

            useEffect(() => {
                // Fetch My Products
                const qP = query(collection(db, 'products'), where('sellerId', '==', user.uid));
                const unsubP = onSnapshot(qP, s => setProducts(s.docs.map(d => ({id:d.id, ...d.data()}))), (e) => console.log("Seller P err", e));
                
                // Fetch Orders for My Products
                const qO = query(collection(db, 'orders'), where('sellerId', '==', user.uid));
                const unsubO = onSnapshot(qO, s => setOrders(s.docs.map(d => ({id:d.id, ...d.data()}))), (e) => console.log("Seller O err", e));

                return () => { unsubP(); unsubO(); };
            }, [user.uid]);

            const saveSettings = async (e) => {
                e.preventDefault();
                try {
                    await updateDoc(doc(db, 'users', user.uid), { upiId });
                    alert("Payment settings saved!");
                } catch (e) {
                    console.error(e);
                    alert("Error saving settings.");
                }
            };

            const addProduct = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'products'), {
                    ...newProd,
                    price: Number(newProd.price),
                    sellerId: user.uid,
                    sellerName: user.displayName || user.email,
                    createdAt: serverTimestamp()
                });
                setNewProd({ name: '', price: '', description: '' });
            };

            const deleteProduct = async (id) => {
                if(confirm("Delete this product?")) await deleteDoc(doc(db, 'products', id));
            };

            const updateOrder = async (id, status) => {
                await updateDoc(doc(db, 'orders', id), { status });
            };

            return (
                <div className="grid lg:grid-cols-3 gap-8">
                    {/* Settings & Add Product */}
                    <div className="lg:col-span-1 space-y-6">
                        <Card className="p-6">
                            <h3 className="font-bold text-gray-900 dark:text-white mb-4">Payment Settings</h3>
                            <form onSubmit={saveSettings} className="space-y-4">
                                <div>
                                    <label className="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Your UPI ID (shown to buyers)</label>
                                    <input 
                                        className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" 
                                        placeholder="e.g. name@upi" 
                                        value={upiId} 
                                        onChange={e=>setUpiId(e.target.value)} 
                                    />
                                </div>
                                <Button type="submit" variant="secondary" className="w-full">Save Settings</Button>
                            </form>
                        </Card>

                        <Card className="p-6">
                            <h3 className="font-bold text-gray-900 dark:text-white mb-4">Add Product</h3>
                            <form onSubmit={addProduct} className="space-y-4">
                                <input className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Product Name" value={newProd.name} onChange={e=>setNewProd({...newProd, name:e.target.value})} required />
                                <input type="number" className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Price (₹)" value={newProd.price} onChange={e=>setNewProd({...newProd, price:e.target.value})} required />
                                <textarea className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows={3} placeholder="Description" value={newProd.description} onChange={e=>setNewProd({...newProd, description:e.target.value})} required />
                                <Button type="submit" className="w-full">List Item</Button>
                            </form>
                        </Card>
                    </div>

                    {/* Product List & Orders */}
                    <div className="lg:col-span-2 space-y-8">
                        <Card className="p-6">
                            <h3 className="font-bold text-gray-900 dark:text-white mb-4">My Products</h3>
                            <div className="space-y-3">
                                {products.map(p => (
                                    <div key={p.id} className="flex justify-between items-center p-3 border rounded dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                                        <div>
                                            <div className="font-bold text-gray-900 dark:text-white">{p.name}</div>
                                            <div className="text-sm text-gray-500 dark:text-gray-400">₹{p.price}</div>
                                        </div>
                                        <button onClick={()=>deleteProduct(p.id)} className="text-red-500 hover:text-red-700"><Trash2 size={18}/></button>
                                    </div>
                                ))}
                                {products.length === 0 && <p className="text-gray-500">No products listed.</p>}
                            </div>
                        </Card>

                        <Card className="p-6">
                            <h3 className="font-bold text-gray-900 dark:text-white mb-4">Incoming Orders</h3>
                            <div className="space-y-3">
                                {orders.map(o => (
                                    <div key={o.id} className="p-4 border rounded dark:border-gray-700 bg-white dark:bg-gray-800">
                                        <div className="flex justify-between mb-2">
                                            <span className="font-bold text-indigo-600 dark:text-indigo-400">{o.productName}</span>
                                            <Badge color={o.status === 'completed' ? 'green' : 'yellow'}>{o.status}</Badge>
                                        </div>
                                        <div className="text-sm text-gray-600 dark:text-gray-300 mb-3">
                                            <div><span className="font-bold">Buyer:</span> {o.buyerEmail}</div>
                                            <div><span className="font-bold">Amount:</span> ₹{o.price}</div>
                                            <div><span className="font-bold">Address:</span> {o.address}</div>
                                        </div>
                                        {o.status === 'pending' && (
                                            <div className="flex gap-2">
                                                <Button onClick={()=>updateOrder(o.id, 'completed')} variant="success" className="!py-1 !text-xs">Mark Completed</Button>
                                                <Button onClick={()=>updateOrder(o.id, 'cancelled')} variant="danger" className="!py-1 !text-xs">Cancel</Button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                                {orders.length === 0 && <p className="text-gray-500">No orders yet.</p>}
                            </div>
                        </Card>
                    </div>
                </div>
            );
        }

        function Login({ onNavigate }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const handleLogin = async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, email, password); onNavigate('home'); } catch (err) { setError("Failed to login. Please check your credentials."); } };
            return (
                <div className="max-w-md mx-auto mt-12">
                    <Card className="p-8">
                        <div className="text-center mb-8"><h2 className="text-2xl font-bold text-gray-900 dark:text-white">Welcome Back</h2><p className="text-gray-500 dark:text-gray-400 mt-2">Sign in to your account</p></div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            {error && <div className="p-3 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 text-sm rounded-lg">{error}</div>}
                            <input type="email" placeholder="Email Address" required className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" value={email} onChange={(e) => setEmail(e.target.value)} />
                            <input type="password" placeholder="Password" required className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" value={password} onChange={(e) => setPassword(e.target.value)} />
                            <Button type="submit" className="w-full">Sign In</Button>
                        </form>
                        <p className="text-center mt-6 text-sm text-gray-600 dark:text-gray-400">Don't have an account? <button onClick={() => onNavigate('signup')} className="text-indigo-600 dark:text-indigo-400 font-medium hover:underline">Sign up</button></p>
                    </Card>
                </div>
            );
        }

        function Signup({ onNavigate }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [agreed, setAgreed] = useState(false);
            const [showTerms, setShowTerms] = useState(false);
            
            const handleSignup = async (e) => { 
                e.preventDefault(); 
                if (!agreed) {
                    setError("You must agree to the Terms and Conditions to create an account.");
                    return;
                }
                try { 
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password); 
                    await sendEmailVerification(userCredential.user);
                    await setDoc(doc(db, 'users', userCredential.user.uid), { 
                        uid: userCredential.user.uid, 
                        email, 
                        displayName: name, 
                        role: 'user', 
                        isActive: true, 
                        termsAccepted: true,
                        termsAcceptedAt: serverTimestamp(),
                        createdAt: serverTimestamp(),
                        lastSeen: serverTimestamp()
                    }); 
                } catch (err) { 
                    setError(err.message); 
                } 
            };

            return (
                <div className="max-w-md mx-auto mt-12">
                    <Card className="p-8">
                        <div className="text-center mb-8"><h2 className="text-2xl font-bold text-gray-900 dark:text-white">Join Shades of Hue</h2><p className="text-gray-500 dark:text-gray-400 mt-2">Create your account today</p></div>
                        <form onSubmit={handleSignup} className="space-y-6">
                            {error && <div className="p-3 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 text-sm rounded-lg">{error}</div>}
                            <input type="text" placeholder="Full Name" required className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" value={name} onChange={(e) => setName(e.target.value)} />
                            <input type="email" placeholder="Email Address" required className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" value={email} onChange={(e) => setEmail(e.target.value)} />
                            <input type="password" placeholder="Password (min 6 chars)" required minLength={6} className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" value={password} onChange={(e) => setPassword(e.target.value)} />
                            
                            <div className="flex items-start gap-2 text-sm text-gray-600 dark:text-gray-400 px-1">
                                <input 
                                    type="checkbox" 
                                    id="terms" 
                                    checked={agreed} 
                                    onChange={(e) => setAgreed(e.target.checked)}
                                    className="mt-1"
                                />
                                <label htmlFor="terms">
                                    I agree to the <button type="button" onClick={() => setShowTerms(true)} className="text-indigo-600 dark:text-indigo-400 hover:underline font-medium">Terms and Conditions</button>
                                </label>
                            </div>

                            <Button type="submit" className="w-full">Sign Up</Button>
                        </form>
                        <p className="text-center mt-6 text-sm text-gray-600 dark:text-gray-400">Already have an account? <button onClick={() => onNavigate('login')} className="text-indigo-600 dark:text-indigo-400 font-medium hover:underline">Sign in</button></p>
                    </Card>
                    {showTerms && <TermsModal onClose={() => setShowTerms(false)} />}
                </div>
            );
        }

        function ChatWindow({ chatId, onClose, currentUser }) {
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [chatInfo, setChatInfo] = useState(null);
            const bottomRef = useRef(null);

            useEffect(() => {
                const fetchChatInfo = async () => {
                    try {
                        const docSnap = await getDoc(doc(db, 'chats', chatId));
                        if (docSnap.exists()) setChatInfo(docSnap.data());
                    } catch (e) { console.error("Chat info error:", e); }
                };
                fetchChatInfo();
                const q = query(collection(db, 'chats', chatId, 'messages'), orderBy('timestamp', 'asc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setTimeout(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                }, (error) => console.error("Chat messages error:", error));
                return () => unsubscribe();
            }, [chatId]);

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!newMessage.trim()) return;
                try {
                    await addDoc(collection(db, 'chats', chatId, 'messages'), {
                        text: newMessage, senderId: currentUser.uid, senderEmail: currentUser.email, timestamp: serverTimestamp()
                    });
                    await updateDoc(doc(db, 'chats', chatId), { lastMessage: newMessage, lastMessageTime: serverTimestamp() });
                    setNewMessage('');
                } catch (error) { console.error("Error sending message:", error); }
            };

            const getOtherParticipantName = () => {
                if (!chatInfo || !chatInfo.participantData) return "Chat";
                const otherUid = chatInfo.participants.find(uid => uid !== currentUser.uid);
                const participant = chatInfo.participantData[otherUid];
                return participant?.name || "User";
            };

            return (
                <div className="fixed bottom-4 right-4 w-96 h-[500px] bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col z-50 overflow-hidden">
                    <div className="bg-indigo-600 text-white p-4 flex justify-between items-center shrink-0">
                        <div className="flex items-center gap-2"><MessageCircle size={20} /><span className="font-bold truncate">{getOtherParticipantName()}</span></div>
                        <button onClick={onClose} className="hover:bg-indigo-700 p-1 rounded"><X size={18} /></button>
                    </div>
                    <div className="flex-grow p-4 overflow-y-auto bg-gray-50 dark:bg-gray-900 flex flex-col gap-3">
                        {messages.map((msg) => {
                            const isMe = msg.senderId === currentUser.uid;
                            return (
                                <div key={msg.id} className={`max-w-[80%] p-3 rounded-lg text-sm ${isMe ? 'bg-indigo-100 dark:bg-indigo-900/40 text-indigo-900 dark:text-indigo-100 self-end rounded-br-none' : 'bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-100 self-start rounded-bl-none'}`}>
                                    <p>{msg.text}</p>
                                    <p className={`text-[10px] mt-1 ${isMe ? 'text-indigo-400 dark:text-indigo-300' : 'text-gray-400 dark:text-gray-400'}`}>{msg.timestamp?.toDate ? msg.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}</p>
                                </div>
                            );
                        })}
                        <div ref={bottomRef} />
                    </div>
                    <form onSubmit={sendMessage} className="p-3 bg-white dark:bg-gray-800 border-t border-gray-100 dark:border-gray-700 flex gap-2 shrink-0">
                        <input type="text" value={newMessage} onChange={(e) => setNewMessage(e.target.value)} placeholder="Type a message..." className="flex-grow px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm text-gray-900 dark:text-white" />
                        <button type="submit" disabled={!newMessage.trim()} className="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"><Send size={18} /></button>
                    </form>
                </div>
            );
        }

        function CommonGrievanceList({ user, role }) {
            const [grievances, setGrievances] = useState([]);
            const [subject, setSubject] = useState('');
            const [description, setDescription] = useState('');
            
            useEffect(() => {
                const q = query(collection(db, 'grievances'), where('userId', '==', user.uid));
                const unsub = onSnapshot(q, (s) => setGrievances(s.docs.map(d => ({id:d.id, ...d.data()}))), (e) => console.log(e));
                return () => unsub();
            }, [user.uid]);

            const submitGrievance = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'grievances'), {
                    userId: user.uid,
                    userEmail: user.email,
                    userName: user.displayName || user.email,
                    userRole: role,
                    subject,
                    description,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                setSubject(''); setDescription(''); alert("Grievance submitted.");
            };

            return (
                <div className="space-y-6">
                    <Card className="p-6">
                        <h3 className="font-bold mb-4 text-gray-900 dark:text-white">Submit Grievance</h3>
                        <form onSubmit={submitGrievance} className="space-y-4">
                            <input className="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Subject" value={subject} onChange={e=>setSubject(e.target.value)} required />
                            <textarea className="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded outline-none focus:ring-2 focus:ring-indigo-500" rows={3} placeholder="Describe your issue..." value={description} onChange={e=>setDescription(e.target.value)} required />
                            <Button type="submit">Submit</Button>
                        </form>
                    </Card>
                    <Card className="p-6">
                        <h3 className="font-bold mb-4 text-gray-900 dark:text-white">My Grievances</h3>
                        <div className="space-y-2">
                            {grievances.map(g => (
                                <div key={g.id} className="p-3 border dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-700/50">
                                    <div className="flex justify-between font-bold text-gray-900 dark:text-white"><span>{g.subject}</span><Badge color={g.status==='resolved'?'green':'red'}>{g.status}</Badge></div>
                                    <p className="text-sm mt-1 text-gray-600 dark:text-gray-300">{g.description}</p>
                                </div>
                            ))}
                            {grievances.length===0 && <p className="text-gray-500 dark:text-gray-400">No records found.</p>}
                        </div>
                    </Card>
                </div>
            );
        }

        // --- ADMIN DASHBOARD ---
        function AdminDashboard({ user }) {
            const [activeTab, setActiveTab] = useState('users');
            const SidebarBtn = ({ icon: Icon, label, active, onClick }) => <button onClick={onClick} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${active ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white'}`}><Icon size={18} />{label}</button>;
            return (
                <div className="grid lg:grid-cols-4 gap-8">
                    <div className="lg:col-span-1 space-y-4">
                        <Card className="p-4"><h3 className="font-bold text-gray-900 dark:text-white mb-4 px-2">Admin Controls</h3><div className="space-y-1">
                            <SidebarBtn icon={User} label="Manage Users" active={activeTab === 'users'} onClick={() => setActiveTab('users')} />
                            <SidebarBtn icon={Plus} label="Create Account" active={activeTab === 'create'} onClick={() => setActiveTab('create')} />
                            <SidebarBtn icon={Activity} label="Request Monitor" active={activeTab === 'requests'} onClick={() => setActiveTab('requests')} />
                            <SidebarBtn icon={Gift} label="Donations" active={activeTab === 'donations'} onClick={() => setActiveTab('donations')} />
                            <SidebarBtn icon={Newspaper} label="Manage News" active={activeTab === 'news'} onClick={() => setActiveTab('news')} />
                            <SidebarBtn icon={IndianRupee} label="Payment Approvals" active={activeTab === 'approvals'} onClick={() => setActiveTab('approvals')} />
                            <SidebarBtn icon={AlertTriangle} label="Grievance Portal" active={activeTab === 'grievances'} onClick={() => setActiveTab('grievances')} />
                            <SidebarBtn icon={MessageSquare} label="Conversation Monitor" active={activeTab === 'messages'} onClick={() => setActiveTab('messages')} />
                        </div></Card>
                    </div>
                    <div className="lg:col-span-3">
                        {activeTab === 'users' && <AdminUserList />} 
                        {activeTab === 'create' && <AdminCreateUser />} 
                        {activeTab === 'requests' && <AdminRequestMonitor />}
                        {activeTab === 'donations' && <AdminDonations />}
                        {activeTab === 'news' && <AdminNewsManager />} 
                        {activeTab === 'approvals' && <AdminPaymentApprovals />} 
                        {activeTab === 'grievances' && <AdminGrievances />} 
                        {activeTab === 'messages' && <AdminMessageCenter />}
                    </div>
                </div>
            );
        }

        function AdminDonations() {
            const [donations, setDonations] = useState([]);
            useEffect(() => {
                const q = query(collection(db, 'donations'), orderBy('createdAt', 'desc'));
                const unsub = onSnapshot(q, s => setDonations(s.docs.map(d => ({id:d.id, ...d.data()}))), e => console.log(e));
                return () => unsub();
            }, []);

            return (
                <Card className="p-6">
                    <h3 className="font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                        <Gift size={20} className="text-rose-600" /> Donations Received
                    </h3>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead>
                                <tr className="border-b text-gray-500 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-700/50">
                                    <th className="p-3 text-gray-500 dark:text-gray-400">Date</th>
                                    <th className="p-3 text-gray-500 dark:text-gray-400">Donor Name</th>
                                    <th className="p-3 text-right text-gray-500 dark:text-gray-400">Amount</th>
                                    <th className="p-3 text-right text-gray-500 dark:text-gray-400">Status</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                                {donations.map(d => (
                                    <tr key={d.id} className="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                        <td className="p-3 text-gray-500 dark:text-gray-400 text-xs">
                                            {d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : 'Just now'}
                                        </td>
                                        <td className="p-3 font-medium text-gray-900 dark:text-white">{d.name}</td>
                                        <td className="p-3 text-right font-bold text-green-600 dark:text-green-400">₹{d.amount}</td>
                                        <td className="p-3 text-right">
                                            <Badge color="green">Received</Badge>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {donations.length === 0 && <p className="text-center py-8 text-gray-500 dark:text-gray-400">No donations recorded yet.</p>}
                    </div>
                </Card>
            )
        }

        function AdminRequestMonitor() {
            const [requests, setRequests] = useState([]);
            const [filter, setFilter] = useState('all');

            useEffect(() => {
                const q = query(collection(db, 'requests'), orderBy('createdAt', 'desc'));
                const unsub = onSnapshot(q, (snapshot) => {
                    setRequests(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (e) => console.log(e));
                return () => unsub();
            }, []);

            const filtered = filter === 'all' ? requests : requests.filter(r => r.status === filter);

            return (
                <Card className="p-6">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <h3 className="font-bold text-gray-900 dark:text-white flex items-center gap-2">
                            <Activity size={20} className="text-indigo-600 dark:text-indigo-400" /> Request Monitor
                        </h3>
                        <select 
                            value={filter} 
                            onChange={(e) => setFilter(e.target.value)}
                            className="p-2 border rounded-lg text-sm bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500 w-full sm:w-auto"
                        >
                            <option value="all">All Status</option>
                            <option value="payment_review">Payment Review</option>
                            <option value="pending">Pending</option>
                            <option value="accepted">Accepted</option>
                            <option value="declined">Declined</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead>
                                <tr className="border-b text-gray-500 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-700/50">
                                    <th className="p-3 font-medium whitespace-nowrap text-gray-500 dark:text-gray-400">Date</th>
                                    <th className="p-3 font-medium whitespace-nowrap text-gray-500 dark:text-gray-400">User</th>
                                    <th className="p-3 font-medium whitespace-nowrap text-gray-500 dark:text-gray-400">Organization</th>
                                    <th className="p-3 font-medium whitespace-nowrap text-gray-500 dark:text-gray-400">Service</th>
                                    <th className="p-3 font-medium text-right whitespace-nowrap text-gray-500 dark:text-gray-400">Price</th>
                                    <th className="p-3 font-medium text-right whitespace-nowrap text-gray-500 dark:text-gray-400">Status</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                                {filtered.map(r => (
                                    <tr key={r.id} className="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                        <td className="p-3 text-gray-500 dark:text-gray-400 text-xs whitespace-nowrap">
                                            {r.createdAt?.toDate ? r.createdAt.toDate().toLocaleDateString() : 'N/A'}
                                            <div className="text-[10px] opacity-75">{r.createdAt?.toDate ? r.createdAt.toDate().toLocaleTimeString() : ''}</div>
                                        </td>
                                        <td className="p-3 whitespace-nowrap">
                                            <div className="font-medium text-gray-900 dark:text-white">{r.userName || 'User'}</div>
                                            <div className="text-xs text-gray-500 dark:text-gray-400">{r.userEmail}</div>
                                        </td>
                                        <td className="p-3 text-gray-600 dark:text-gray-300 whitespace-nowrap">{r.orgName}</td>
                                        <td className="p-3 font-medium text-indigo-600 dark:text-indigo-400 whitespace-nowrap">{r.serviceName}</td>
                                        <td className="p-3 text-right text-gray-600 dark:text-gray-300 whitespace-nowrap">{r.servicePrice ? `₹${r.servicePrice}` : '-'}</td>
                                        <td className="p-3 text-right whitespace-nowrap">
                                            <Badge color={
                                                r.status === 'completed' ? 'green' : 
                                                r.status === 'accepted' ? 'blue' : 
                                                r.status === 'declined' ? 'red' :
                                                r.status === 'cancelled' ? 'gray' : 
                                                'yellow'
                                            }>
                                                {r.status === 'payment_review' ? 'Payment' : r.status}
                                            </Badge>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {filtered.length === 0 && (
                            <div className="text-center py-8 text-gray-500 dark:text-gray-400">No requests found.</div>
                        )}
                    </div>
                </Card>
            );
        }

        function AdminUserList() {
            const [users, setUsers] = useState([]);
            const [confirmingId, setConfirmingId] = useState(null);
            
            useEffect(() => { 
                const unsub = onSnapshot(collection(db, 'users'), (s) => {
                    const data = s.docs.map(d => ({id:d.id, ...d.data()}));
                    data.sort((a,b) => {
                        // Sort by active status first, then last seen
                        if (a.isActive !== b.isActive) return a.isActive ? -1 : 1;
                        const timeA = a.lastSeen?.seconds || 0;
                        const timeB = b.lastSeen?.seconds || 0;
                        return timeB - timeA;
                    });
                    setUsers(data);
                }, (e) => console.log(e)); 
                return () => unsub(); 
            }, []);

            const toggleStatus = async (uid, status) => { await updateDoc(doc(db, 'users', uid), { isActive: !status }); };
            const deleteUser = async (uid) => { if (confirmingId === uid) { await deleteDoc(doc(db, 'users', uid)); setConfirmingId(null); } else { setConfirmingId(uid); setTimeout(() => setConfirmingId(null), 3000); } };
            
            return (
                <Card className="p-6"><h3 className="text-xl font-bold text-gray-900 dark:text-white mb-6">User Management</h3><div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead><tr className="border-b text-gray-500 dark:border-gray-700"><th className="text-gray-500 dark:text-gray-400">User</th><th className="text-gray-500 dark:text-gray-400">Role</th><th className="text-gray-500 dark:text-gray-400">Online Status</th><th className="text-gray-500 dark:text-gray-400">Last Seen</th><th className="text-gray-500 dark:text-gray-400">Account Status</th><th className="text-right text-gray-500 dark:text-gray-400">Actions</th></tr></thead><tbody className="divide-y divide-gray-100 dark:divide-gray-700">{users.map(u => {
                    // Logic for Online Status
                    const now = new Date();
                    const lastSeen = u.lastSeen?.toDate ? u.lastSeen.toDate() : new Date(0);
                    const diff = (now - lastSeen) / 1000 / 60; // difference in minutes
                    const isOnline = diff < 2; // Consider online if seen in last 2 mins

                    return (
                        <tr key={u.id} className={!u.isActive ? "bg-amber-50 dark:bg-amber-900/10" : "hover:bg-gray-50 dark:hover:bg-gray-700/50"}>
                            <td className="py-3">
                                <div className="font-medium text-gray-900 dark:text-white">{u.displayName}</div>
                                <div className="text-xs text-gray-500 dark:text-gray-400">{u.email}</div>
                            </td>
                            <td className="capitalize"><Badge color={u.role==='admin'?'purple':u.role==='organization'?'blue':'gray'}>{u.role}</Badge></td>
                            
                            {/* NEW: Online Status Column */}
                            <td>
                                {isOnline ? (
                                    <span className="flex items-center gap-1.5 text-green-700 dark:text-green-400 font-medium text-xs bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded-full w-fit">
                                        <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Online
                                    </span>
                                ) : (
                                    <span className="flex items-center gap-1.5 text-gray-500 dark:text-gray-400 text-xs px-2 py-1">
                                        <span className="w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-600"></span> Offline
                                    </span>
                                )}
                            </td>

                            {/* NEW: Last Seen Column */}
                            <td className="text-xs text-gray-500 dark:text-gray-400">
                                {u.lastSeen?.toDate ? u.lastSeen.toDate().toLocaleString([], {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}) : 'Never'}
                            </td>

                            <td>{u.isActive?<span className="text-green-600 dark:text-green-400 flex items-center gap-1"><CheckCircle size={14}/> Active</span>:<span className="text-amber-600 dark:text-amber-400 flex items-center gap-1"><Clock size={14}/> Pending</span>}</td>
                            <td className="text-right space-x-2">{!SUPER_ADMINS.includes(u.email) && <><button onClick={()=>toggleStatus(u.id, u.isActive)} className={!u.isActive ? "text-green-600 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-900/30 p-1 rounded" : "text-gray-400 dark:text-gray-500"} title={u.isActive ? "Deactivate" : "Approve"}>{u.isActive ? <XCircle size={16}/> : <CheckCircle size={16}/>}</button><button onClick={()=>deleteUser(u.id)} className={confirmingId === u.id ? "text-red-600 dark:text-red-400 font-bold" : "text-gray-400 dark:text-gray-500 hover:text-red-600 dark:hover:text-red-400"}>{confirmingId === u.id ? "Sure?" : <Trash2 size={16}/>}</button></>}</td>
                        </tr>
                    );
                })}</tbody></table></div></Card>
            );
        }

        function AdminCreateUser() {
            const [form, setForm] = useState({email:'', password:'', name:'', role:'organization'});
            const [msg, setMsg] = useState({type:'', text:''});
            const handleCreate = async (e) => {
                e.preventDefault(); setMsg({type:'info', text:'Creating...'});
                let secondaryApp;
                try {
                    // Create a unique app instance name to prevent "App already exists" errors
                    secondaryApp = initializeApp(firebaseConfig, `Secondary-${Date.now()}`);
                    const secAuth = getAuth(secondaryApp);
                    
                    const cred = await createUserWithEmailAndPassword(secAuth, form.email, form.password);
                    
                    // Note: setDoc uses the PRIMARY app's db instance (authenticated as Admin)
                    // The Rules update below allows this because the authenticated user is an Admin
                    await setDoc(doc(db, 'users', cred.user.uid), { 
                        uid: cred.user.uid, 
                        email: form.email, 
                        displayName: form.name, 
                        role: form.role, 
                        isActive: true, 
                        createdAt: serverTimestamp(), 
                        lastSeen: serverTimestamp(),
                        ...(form.role==='organization'?{description:'New Org', services:[]}:{}) 
                    });
                    
                    await signOut(secAuth);
                    setMsg({type:'success', text:'Account created successfully!'}); 
                    setForm({email:'', password:'', name:'', role:'organization'});
                } catch(err) { 
                    setMsg({type:'error', text:err.message}); 
                } finally {
                    // Clean up the secondary app instance
                    if (secondaryApp) {
                        try { await deleteApp(secondaryApp); } catch (e) { console.error("Cleanup error", e); }
                    }
                }
            };
            return (
                <Card className="p-8 max-w-xl mx-auto">
                    <h3 className="text-xl font-bold mb-6 text-gray-900 dark:text-white">Create Account</h3>
                    <form onSubmit={handleCreate} className="space-y-4">
                        {msg.text && <div className={`p-2 text-sm rounded ${msg.type==='error'?'bg-red-50 text-red-700':'bg-green-50 text-green-700'}`}>{msg.text}</div>}
                        <div className="flex gap-4 mb-2 flex-wrap">
                            <label className="flex items-center gap-2 text-gray-700 dark:text-gray-300">
                                <input type="radio" checked={form.role==='organization'} onChange={()=>setForm({...form, role:'organization'})} /> Org
                            </label>
                            <label className="flex items-center gap-2 text-gray-700 dark:text-gray-300">
                                <input type="radio" checked={form.role==='seller'} onChange={()=>setForm({...form, role:'seller'})} /> Seller
                            </label>
                            <label className="flex items-center gap-2 text-gray-700 dark:text-gray-300">
                                <input type="radio" checked={form.role==='admin'} onChange={()=>setForm({...form, role:'admin'})} /> Admin
                            </label>
                        </div>
                        <input className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Name" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} required />
                        <input className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Email" type="email" value={form.email} onChange={e=>setForm({...form, email:e.target.value})} required />
                        <input className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Password" type="password" value={form.password} onChange={e=>setForm({...form, password:e.target.value})} required />
                        <Button type="submit" className="w-full">Create</Button>
                    </form>
                </Card>
            );
        }

        function AdminNewsManager() {
            const [news, setNews] = useState({title:'', content:''});
            const [newsList, setNewsList] = useState([]);
            const [confirmId, setConfirmId] = useState(null);
            useEffect(() => { const q = query(collection(db, 'news'), orderBy('createdAt', 'desc')); const unsub = onSnapshot(q, (s) => setNewsList(s.docs.map(d => ({ id: d.id, ...d.data() }))), e => console.log(e)); return () => unsub(); }, []);
            const post = async (e) => { e.preventDefault(); try { await addDoc(collection(db, 'news'), {...news, createdAt: serverTimestamp()}); setNews({title:'', content:''}); } catch (e) { console.error(e); } };
            const deleteNews = async (id) => { if (confirmId === id) { await deleteDoc(doc(db, 'news', id)); setConfirmId(null); } else { setConfirmId(id); setTimeout(() => setConfirmId(null), 3000); } };
            return (
                <div className="space-y-8"><Card className="p-6"><h3 className="font-bold mb-4 text-gray-900 dark:text-white">Post News</h3><form onSubmit={post} className="space-y-4"><input className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Title" value={news.title} onChange={e=>setNews({...news, title:e.target.value})} required /><textarea className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" rows={3} placeholder="Content" value={news.content} onChange={e=>setNews({...news, content:e.target.value})} required /><Button type="submit">Publish</Button></form></Card><Card className="p-6"><h3 className="font-bold mb-4 text-gray-900 dark:text-white">Manage Updates</h3><div className="space-y-4">{newsList.map(item => (<div key={item.id} className="p-4 border dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-700/50 flex justify-between items-start group"><div><h4 className="font-bold text-gray-900 dark:text-white">{item.title}</h4><p className="text-sm text-gray-600 dark:text-gray-300 mt-1 whitespace-pre-wrap">{item.content}</p><div className="text-xs text-gray-400 mt-2">{item.createdAt?.toDate ? item.createdAt.toDate().toLocaleDateString() : 'Just now'}</div></div><button onClick={() => deleteNews(item.id)} className={`p-2 rounded transition-colors ${confirmId === item.id ? 'bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400' : 'text-gray-400 dark:text-gray-500 hover:text-red-600 dark:hover:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600'}`} title="Delete">{confirmId === item.id ? <span className="text-xs font-bold">Sure?</span> : <Trash2 size={18} />}</button></div>))}{newsList.length === 0 && <p className="text-gray-500 dark:text-gray-400 text-sm">No updates posted.</p>}</div></Card></div>
            );
        }

        function AdminPaymentApprovals() {
            const [requests, setRequests] = useState([]);
            const [confirmingId, setConfirmingId] = useState(null);
            useEffect(() => { const q = query(collection(db, 'requests'), where('status', '==', 'payment_review')); const unsub = onSnapshot(q, (s) => { const data = s.docs.map(d => ({ id: d.id, ...d.data() })); data.sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds); setRequests(data); }, e => console.log(e)); return () => unsub(); }, []);
            const handleClick = (id) => { if (confirmingId === id) { approvePayment(id); } else { setConfirmingId(id); setTimeout(() => setConfirmingId(null), 3000); } };
            const approvePayment = async (id) => { try { await updateDoc(doc(db, 'requests', id), { status: 'pending' }); setConfirmingId(null); } catch (e) { console.error(e); } };
            return (
                <Card className="p-6"><h3 className="font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2"><IndianRupee size={20} className="text-indigo-600 dark:text-indigo-400" /> Payment Approvals</h3><div className="space-y-3">{requests.map(req => (<div key={req.id} className="p-4 border border-indigo-100 dark:border-indigo-900 rounded-lg bg-indigo-50/50 dark:bg-indigo-900/10 flex flex-col md:flex-row justify-between items-center gap-4"><div><div className="font-bold text-gray-900 dark:text-white">{req.serviceName} <span className="text-gray-500 dark:text-gray-400 font-normal">(₹{req.servicePrice || 'N/A'})</span></div><div className="text-sm text-gray-600 dark:text-gray-300">User: {req.userEmail}</div><div className="text-xs text-gray-400 mt-1">To: {req.orgName}</div></div><Button onClick={() => handleClick(req.id)} variant={confirmingId === req.id ? 'danger' : 'success'} className="!py-1.5 !px-4 !text-sm transition-all">{confirmingId === req.id ? 'Confirm Approval?' : <><Check size={16} /> Approve Payment</>}</Button></div>))}{requests.length === 0 && <p className="text-gray-500 dark:text-gray-400 text-center py-4">No pending payments.</p>}</div></Card>
            );
        }

        function AdminGrievances() {
            const [grievances, setGrievances] = useState([]);
            useEffect(() => {
                const q = query(collection(db, 'grievances'));
                const unsub = onSnapshot(q, (s) => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    data.sort((a,b) => b.createdAt?.seconds - a.createdAt?.seconds);
                    setGrievances(data);
                }, e => console.log(e));
                return () => unsub();
            }, []);

            const resolveGrievance = async (id) => {
                await updateDoc(doc(db, 'grievances', id), { status: 'resolved' });
            };

            return (
                <Card className="p-6"><h3 className="font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2"><AlertTriangle size={20} className="text-amber-600 dark:text-amber-400" /> Grievance Portal</h3><div className="space-y-4">{grievances.map(g => (
                    <div key={g.id} className="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <div className="flex justify-between items-start">
                            <div>
                                <div className="font-bold text-lg text-gray-900 dark:text-white">{g.subject} <Badge color={g.status==='resolved'?'green':'red'}>{g.status}</Badge></div>
                                <div className="text-sm text-gray-500 dark:text-gray-400 mt-1">From: {g.userEmail} ({g.userRole})</div>
                                <p className="mt-2 text-gray-700 dark:text-gray-300">{g.description}</p>
                            </div>
                            {g.status !== 'resolved' && <Button variant="secondary" onClick={() => resolveGrievance(g.id)} className="!py-1 !text-sm">Mark Resolved</Button>}
                        </div>
                    </div>
                ))}
                {grievances.length === 0 && <div className="text-center text-gray-500 dark:text-gray-400">No grievances found.</div>}</div></Card>
            );
        }

        function AdminMessageCenter() {
            const [chats, setChats] = useState([]);
            const [selectedChat, setSelectedChat] = useState(null);
            useEffect(() => {
                const q = query(collection(db, 'chats'));
                const unsub = onSnapshot(q, (s) => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    data.sort((a,b) => (b.lastMessageTime?.seconds || 0) - (a.lastMessageTime?.seconds || 0));
                    setChats(data);
                }, e => console.log(e));
                return () => unsub();
            }, []);
            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]"><Card className="col-span-1 flex flex-col h-full"><div className="p-4 border-b border-gray-100 dark:border-gray-700"><h3 className="font-bold text-gray-900 dark:text-white">Conversations</h3></div><div className="overflow-y-auto flex-1 p-2 space-y-2">{chats.map(chat => (<div key={chat.id} onClick={() => setSelectedChat(chat)} className={`p-3 rounded-lg cursor-pointer border transition-all ${selectedChat?.id === chat.id ? 'bg-indigo-50 dark:bg-indigo-900/30 border-indigo-200 dark:border-indigo-800' : 'hover:bg-gray-50 dark:hover:bg-gray-700/50 border-transparent'}`}><div className="text-xs font-bold text-gray-700 dark:text-gray-200 truncate">{Object.values(chat.participantData || {}).map(p => p.name).join(' & ')}</div><div className="text-xs text-gray-500 dark:text-gray-400 truncate mt-1">{chat.lastMessage || 'No messages'}</div><div className="text-[10px] text-gray-400 dark:text-gray-500 mt-1 text-right">{chat.lastMessageTime?.toDate ? chat.lastMessageTime.toDate().toLocaleDateString() : ''}</div></div>))}{chats.length === 0 && <div className="p-4 text-center text-gray-500 dark:text-gray-400 text-sm">No chats found</div>}</div></Card><Card className="col-span-1 lg:col-span-2 flex flex-col h-full overflow-hidden">{selectedChat ? (<AdminChatDetails chat={selectedChat} />) : (<div className="h-full flex items-center justify-center text-gray-400 dark:text-gray-500 bg-gray-50/50 dark:bg-gray-800/50">Select a conversation to monitor</div>)}</Card></div>
            );
        }

        function AdminChatDetails({ chat }) {
            const [messages, setMessages] = useState([]);
            const bottomRef = useRef(null);
            useEffect(() => {
                const q = query(collection(db, 'chats', chat.id, 'messages'), orderBy('timestamp', 'asc'));
                const unsub = onSnapshot(q, (s) => {
                    setMessages(s.docs.map(d => ({id: d.id, ...d.data()})));
                    setTimeout(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                }, e => console.log(e));
                return () => unsub();
            }, [chat.id]);
            return (
                <div className="flex flex-col h-full"><div className="p-4 border-b bg-gray-50 dark:bg-gray-700/50 dark:border-gray-700"><h4 className="font-bold text-gray-800 dark:text-white text-sm">{Object.values(chat.participantData || {}).map(p => `${p.name}`).join(' ↔ ')}</h4></div><div className="flex-1 overflow-y-auto p-4 space-y-3 bg-white dark:bg-gray-800">{messages.map(m => { const sender = chat.participantData?.[m.senderId]; const senderName = sender ? sender.name : m.senderEmail; return (<div key={m.id} className="flex flex-col"><div className="flex justify-between items-end mb-1"><span className="text-xs font-bold text-indigo-600 dark:text-indigo-400">{senderName}</span><span className="text-[10px] text-gray-400">{m.timestamp?.toDate ? m.timestamp.toDate().toLocaleTimeString() : ''}</span></div><div className="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg rounded-tl-none text-sm text-gray-800 dark:text-gray-200">{m.text}</div></div>); })}<div ref={bottomRef} /></div></div>
            );
        }

        function OrgDashboard({ user, userData }) {
            const [activeTab, setActiveTab] = useState('services');
            return (
                <div className="space-y-6">
                    <Card className="p-6">
                        <div className="flex justify-between items-center mb-6"><div className="flex items-center gap-4"><div className="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-400"><Building2 size={32} /></div><div><h2 className="text-2xl font-bold text-gray-900 dark:text-white">{userData?.displayName || 'Organization'}</h2><p className="text-gray-500 dark:text-gray-400">{userData?.email}</p></div></div><div className="flex gap-2"><Button onClick={() => setActiveTab('services')} variant={activeTab === 'services' ? 'primary' : 'secondary'} className="!py-1.5">Services</Button><Button onClick={() => setActiveTab('requests')} variant={activeTab === 'requests' ? 'primary' : 'secondary'} className="!py-1.5">Requests</Button><Button onClick={() => setActiveTab('grievances')} variant={activeTab === 'grievances' ? 'primary' : 'secondary'} className="!py-1.5">Support</Button></div></div>
                        {activeTab === 'services' && <OrgServices user={user} />}
                        {activeTab === 'requests' && <OrgRequests user={user} />}
                        {activeTab === 'grievances' && <CommonGrievanceList user={user} role="organization" />}
                    </Card>
                </div>
            );
        }

        function OrgServices({ user }) {
            const [services, setServices] = useState([]);
            const [newService, setNewService] = useState({ name: '', description: '', price: '' });
            useEffect(() => { const q = query(collection(db, 'services'), where('orgId', '==', user.uid)); const unsub = onSnapshot(q, (s) => setServices(s.docs.map(d => ({id:d.id, ...d.data()})))); return () => unsub(); }, [user.uid]);
            const addService = async (e) => { e.preventDefault(); await addDoc(collection(db, 'services'), { ...newService, orgId: user.uid, orgName: user.displayName || user.email, createdAt: serverTimestamp() }); setNewService({ name: '', description: '', price: '' }); };
            const deleteService = async (id) => { if(confirm('Delete service?')) await deleteDoc(doc(db, 'services', id)); };
            return (
                <div className="space-y-6"><h3 className="font-bold text-lg text-gray-900 dark:text-white">Manage Services</h3><form onSubmit={addService} className="grid md:grid-cols-4 gap-4 bg-gray-50 dark:bg-gray-700/30 p-4 rounded-xl border border-gray-100 dark:border-gray-700"><input className="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Service Name" value={newService.name} onChange={e=>setNewService({...newService, name:e.target.value})} required /><input className="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white md:col-span-2" placeholder="Description" value={newService.description} onChange={e=>setNewService({...newService, description:e.target.value})} required /><input type="number" className="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Price (₹)" value={newService.price} onChange={e=>setNewService({...newService, price:e.target.value})} required /><Button type="submit" className="md:col-span-4">Add Service</Button></form><div className="grid md:grid-cols-2 gap-4">{services.map(s => (<div key={s.id} className="p-4 border dark:border-gray-700 rounded-lg flex justify-between items-start bg-white dark:bg-gray-800"><div><h4 className="font-bold text-gray-900 dark:text-white">{s.name}</h4><p className="text-sm text-gray-600 dark:text-gray-300 my-1">{s.description}</p><p className="font-bold text-indigo-600 dark:text-indigo-400">₹{s.price}</p></div><button onClick={()=>deleteService(s.id)} className="text-gray-400 hover:text-red-500"><Trash2 size={18}/></button></div>))}</div></div>
            );
        }

        function OrgRequests({ user }) {
            const [requests, setRequests] = useState([]);
            useEffect(() => { const q = query(collection(db, 'requests'), where('orgId', '==', user.uid)); const unsub = onSnapshot(q, (s) => setRequests(s.docs.map(d => ({id:d.id, ...d.data()})))); return () => unsub(); }, [user.uid]);
            const updateStatus = async (id, status) => { await updateDoc(doc(db, 'requests', id), { status }); };
            return (
                <div className="space-y-4"><h3 className="font-bold text-lg text-gray-900 dark:text-white">Incoming Requests</h3>{requests.map(r => (<div key={r.id} className="p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700/30"><div className="flex justify-between mb-2"><span className="font-bold text-gray-900 dark:text-white">{r.serviceName}</span><Badge color={r.status==='completed'?'green':r.status==='pending'?'yellow':'blue'}>{r.status}</Badge></div><p className="text-sm text-gray-600 dark:text-gray-300 mb-3">User: {r.userEmail}<br/>Date: {r.createdAt?.toDate ? r.createdAt.toDate().toLocaleDateString() : 'N/A'}</p><div className="flex gap-2">{r.status==='pending' && (<><Button onClick={()=>updateStatus(r.id, 'accepted')} variant="success" className="!py-1 !text-xs">Accept</Button><Button onClick={()=>updateStatus(r.id, 'declined')} variant="danger" className="!py-1 !text-xs">Decline</Button></>)}{r.status==='accepted' && <Button onClick={()=>updateStatus(r.id, 'in_progress')} className="!py-1 !text-xs">Start Progress</Button>}{r.status==='in_progress' && <Button onClick={()=>updateStatus(r.id, 'payment_review')} className="!py-1 !text-xs">Request Payment Review</Button>}</div></div>))}{requests.length === 0 && <p className="text-gray-500 dark:text-gray-400">No requests yet.</p>}</div>
            );
        }

        function UserDashboard({ user, userData }) {
            const [activeTab, setActiveTab] = useState('browse');
            return (
                <div className="grid md:grid-cols-4 gap-6">
                    <Card className="md:col-span-1 p-6 h-fit"><div className="flex flex-col items-center text-center mb-6"><div className="w-20 h-20 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-400 mb-4"><User size={40} /></div><h3 className="font-bold text-lg text-gray-900 dark:text-white">{userData?.displayName}</h3><p className="text-sm text-gray-500 dark:text-gray-400">{user.email}</p></div><div className="space-y-2"><button onClick={()=>setActiveTab('browse')} className={`w-full text-left px-4 py-2 rounded transition-colors ${activeTab==='browse'?'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300':'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'}`}>Browse Services</button><button onClick={()=>setActiveTab('my_requests')} className={`w-full text-left px-4 py-2 rounded transition-colors ${activeTab==='my_requests'?'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300':'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'}`}>My Requests</button><button onClick={()=>setActiveTab('my_orders')} className={`w-full text-left px-4 py-2 rounded transition-colors ${activeTab==='my_orders'?'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300':'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'}`}>My Orders</button><button onClick={()=>setActiveTab('chats')} className={`w-full text-left px-4 py-2 rounded transition-colors ${activeTab==='chats'?'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300':'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'}`}>Messages</button><button onClick={()=>setActiveTab('grievances')} className={`w-full text-left px-4 py-2 rounded transition-colors ${activeTab==='grievances'?'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300':'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'}`}>Support</button></div></Card>
                    <div className="md:col-span-3">
                        {activeTab === 'browse' && <UserBrowseServices user={user} />}
                        {activeTab === 'my_requests' && <UserRequests user={user} />}
                        {activeTab === 'my_orders' && <UserOrders user={user} />}
                        {activeTab === 'chats' && <UserChats user={user} />}
                        {activeTab === 'grievances' && <CommonGrievanceList user={user} role="user" />}
                    </div>
                </div>
            );
        }

        function UserOrders({ user }) {
            const [orders, setOrders] = useState([]);
            useEffect(() => { const q = query(collection(db, 'orders'), where('buyerId', '==', user.uid)); const unsub = onSnapshot(q, s => setOrders(s.docs.map(d => ({id:d.id, ...d.data()})))); return () => unsub(); }, [user.uid]);
            return (
                <Card className="p-6"><h3 className="font-bold text-lg mb-4 text-gray-900 dark:text-white">My Orders</h3><div className="space-y-4">{orders.map(o => (
                    <div key={o.id} className="p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700/30">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="font-bold text-gray-900 dark:text-white">{o.productName}</p>
                                <p className="text-sm text-gray-500 dark:text-gray-400">Price: ₹{o.price}</p>
                                {o.sellerUpiId && o.status === 'pending' && (
                                    <div className="mt-2 p-2 bg-indigo-100 dark:bg-indigo-900/40 border border-indigo-200 dark:border-indigo-800 rounded text-sm text-indigo-900 dark:text-indigo-200">
                                        <p className="text-xs uppercase font-bold opacity-70">Payment Details</p>
                                        <div className="flex items-center gap-2 mt-1">
                                            <span>UPI:</span>
                                            <span className="font-mono font-bold select-all bg-white dark:bg-gray-800 px-1 rounded">{o.sellerUpiId}</span>
                                        </div>
                                        <p className="text-xs mt-1 opacity-75">Please pay via UPI app and wait for seller confirmation.</p>
                                    </div>
                                )}
                            </div>
                            <Badge color={o.status==='completed'?'green':'yellow'}>{o.status}</Badge>
                        </div>
                    </div>
                ))}{orders.length === 0 && <p className="text-gray-500 dark:text-gray-400">No orders placed.</p>}</div></Card>
            );
        }

        function UserBrowseServices({ user }) {
            const [services, setServices] = useState([]);
            useEffect(() => { const q = query(collection(db, 'services')); const unsub = onSnapshot(q, s => setServices(s.docs.map(d => ({id:d.id, ...d.data()})))); return () => unsub(); }, []);
            const requestService = async (s) => {
                if(confirm(`Request ${s.name} from ${s.orgName}?`)) {
                    await addDoc(collection(db, 'requests'), {
                        userId: user.uid, userEmail: user.email, userName: user.displayName||'User',
                        orgId: s.orgId, orgName: s.orgName,
                        serviceId: s.id, serviceName: s.name, servicePrice: s.price,
                        status: 'pending', createdAt: serverTimestamp()
                    });
                    alert("Request sent!");
                }
            };
            const startChat = async (orgId, orgName) => {
                const chatId = [user.uid, orgId].sort().join('_');
                const chatRef = doc(db, 'chats', chatId);
                const chatSnap = await getDoc(chatRef);
                if (!chatSnap.exists()) {
                    await setDoc(chatRef, {
                        participants: [user.uid, orgId],
                        participantData: {
                            [user.uid]: { name: user.displayName || user.email, email: user.email },
                            [orgId]: { name: orgName, email: "Org" } 
                        },
                        lastMessage: '', lastMessageTime: serverTimestamp()
                    });
                }
                // In a real app, this would open the chat window directly. 
                // For this demo, we'll alert the user to go to the Messages tab.
                alert(`Conversation started with ${orgName}. Please go to the 'Messages' tab to chat.`);
            };

            return (
                <Card className="p-6"><h3 className="font-bold text-lg mb-4 text-gray-900 dark:text-white">Available Services</h3><div className="grid md:grid-cols-2 gap-4">{services.map(s => (<div key={s.id} className="p-4 border dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 shadow-sm hover:shadow-md transition-shadow"><h4 className="font-bold text-gray-900 dark:text-white">{s.name}</h4><p className="text-sm text-gray-500 dark:text-gray-400">{s.orgName}</p><p className="my-2 text-gray-600 dark:text-gray-300 text-sm">{s.description}</p><div className="flex justify-between items-center mt-3"><span className="font-bold text-indigo-600 dark:text-indigo-400">₹{s.price}</span><div className="flex gap-2"><button onClick={()=>startChat(s.orgId, s.orgName)} className="p-2 text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400" title="Chat"><MessageCircle size={18}/></button><Button onClick={()=>requestService(s)} className="!py-1 !px-3 !text-xs">Request</Button></div></div></div>))}{services.length===0 && <p className="text-gray-500 dark:text-gray-400 col-span-2 text-center py-8">No services available.</p>}</div></Card>
            );
        }

        function UserRequests({ user }) {
            const [requests, setRequests] = useState([]);
            useEffect(() => { const q = query(collection(db, 'requests'), where('userId', '==', user.uid)); const unsub = onSnapshot(q, s => setRequests(s.docs.map(d => ({id:d.id, ...d.data()})))); return () => unsub(); }, [user.uid]);
            const cancelRequest = async (id) => { if(confirm("Cancel this request?")) await updateDoc(doc(db, 'requests', id), { status: 'cancelled' }); };
            return (
                <Card className="p-6"><h3 className="font-bold text-lg mb-4 text-gray-900 dark:text-white">My Requests</h3><div className="space-y-4">{requests.map(r => (<div key={r.id} className="p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700/30"><div className="flex justify-between mb-1"><span className="font-bold text-gray-900 dark:text-white">{r.serviceName}</span><Badge color={r.status==='completed'?'green':r.status==='cancelled'?'red':'blue'}>{r.status}</Badge></div><p className="text-sm text-gray-500 dark:text-gray-400 mb-2">Org: {r.orgName}</p>{(r.status==='pending'||r.status==='accepted') && <button onClick={()=>cancelRequest(r.id)} className="text-xs text-red-500 hover:underline">Cancel Request</button>}</div>))}{requests.length===0 && <p className="text-gray-500 dark:text-gray-400">No requests made.</p>}</div></Card>
            );
        }

        function UserChats({ user }) {
            const [chats, setChats] = useState([]);
            const [activeChat, setActiveChat] = useState(null);
            useEffect(() => { const q = query(collection(db, 'chats'), where('participants', 'array-contains', user.uid)); const unsub = onSnapshot(q, s => setChats(s.docs.map(d => ({id:d.id, ...d.data()})))); return () => unsub(); }, [user.uid]);
            return (
                <div className="grid md:grid-cols-3 h-[500px] gap-4">
                    <Card className="md:col-span-1 overflow-y-auto p-2">
                        <h3 className="font-bold p-2 text-gray-900 dark:text-white">Messages</h3>
                        {chats.map(c => {
                            const otherId = c.participants.find(p => p !== user.uid);
                            const name = c.participantData?.[otherId]?.name || 'Chat';
                            return (
                                <div key={c.id} onClick={()=>setActiveChat(c.id)} className={`p-3 rounded cursor-pointer mb-2 transition-colors ${activeChat===c.id ? 'bg-indigo-50 dark:bg-indigo-900/30' : 'hover:bg-gray-50 dark:hover:bg-gray-700/50'}`}>
                                    <div className="font-bold text-sm text-gray-900 dark:text-white">{name}</div>
                                    <div className="text-xs text-gray-500 dark:text-gray-400 truncate">{c.lastMessage || 'Start chatting...'}</div>
                                </div>
                            );
                        })}
                        {chats.length===0 && <p className="text-gray-500 dark:text-gray-400 text-sm p-2">No conversations.</p>}
                    </Card>
                    <div className="md:col-span-2 h-full relative">
                        {activeChat && <ChatWindow chatId={activeChat} onClose={()=>setActiveChat(null)} currentUser={user} />}
                        {!activeChat && <Card className="h-full flex items-center justify-center text-gray-400 dark:text-gray-500 bg-gray-50 dark:bg-gray-800/50 border-dashed">Select a conversation</Card>}
                    </div>
                </div>
            );
        }

        // --- RENDER APP ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>